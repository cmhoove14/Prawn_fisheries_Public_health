---
title: "Full Analysis"
author: "Chris Hoover"
date: "August 22, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(deSolve)
require(sensitivity)
require(parallel)
require(tidyverse)

 multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
    library(grid)
    
    # Make a list from the ... arguments and plotlist
    plots <- c(list(...), plotlist)
    
    numPlots = length(plots)
    
    # If layout is NULL, then use 'cols' to determine layout
    if (is.null(layout)) {
      # Make the panel
      # ncol: Number of columns of plots
      # nrow: Number of rows needed, calculated from # of cols
      layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                       ncol = cols, nrow = ceiling(numPlots/cols))
    }
    
    if (numPlots==1) {
      print(plots[[1]])
      
    } else {
      # Set up the page
      grid.newpage()
      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
      
      # Make each plot, in the correct location
      for (i in 1:numPlots) {
        # Get the i,j matrix positions of the regions that contain this subplot
        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
        
        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                        layout.pos.col = matchidx$col))
      }
    }
  }

```

# Figure 2: Numeric estimation of max profit  
For each prawn species, shows trajectories of length, density, harvestable biomass, and profit over time over a range of stocking densities

```{r Opt_stock, include=FALSE, cache = TRUE}
source('Prawn_aquaculture/prawn_aquaculture_mod.R')

#Simulation for eumetric curve for M. volenhovenii #####
#Starting length of 40 mm corresponds to juveniles of ~0.35 grams
opt.df = expand.grid(L_nought = 40, P_nought = seq(500, 7500, 100)) 
  opt.df$h.t = 0
  opt.df$h.bm = 0
  opt.df$h.frac = 0
  opt.df$m.bm = 0
  opt.df$p.bm = 0
  opt.df$p.surv = 0
  opt.df$Revenue = 0
  opt.df$Profit = 0
  opt.df$ROI = 0

par.aqua['k'] = k.vol       # Growth rate (mm/day)

  for(k in 1:nrow(opt.df)){
    start = c(P = opt.df[k,2], L = opt.df[k,1])
    market_frac = predict(eta.lm, newdata = data.frame(dens = start["P"]/area))

  #Run model with above starting conditions  
    op = as.data.frame(ode(start,t.p,prawn_biomass,par.aqua))
    
  #Estimate additional values for simulation  
    op$B = 10^par.aqua['a.p']*(op$L/10)^par.aqua['b.p']     # Mean prawn biomass, transformed from length in mm
    op$Bt = op$P*op$B #Total biomass in grams of prawn population
    op$harvest_mass = op$Bt * market_frac   #harvest biomass estimated as total biomass times marketable fraction
    op$revenue = (op$harvest_mass/1000)*p    #revenue generated by harvest
    op$profit = op$revenue*exp(-delta*op$time) - cost*(start["P"])   #profit generated by harvest
    op$roi = op$profit / (cost*(start["P"]))
    
  #Store parameters of optimal management  
    max_profit = max(op$profit)
    
    opt.df[k,3] = op$time[op$profit==max_profit]  # harvest time
    opt.df[k,4] = op$Bt[op$profit==max_profit]    # Total prawn biomass
    opt.df[k,5] = market_frac # Fraction of harvest that's marketable as function of stocking density
    opt.df[k,6] = opt.df[k,4] * opt.df[k,5]           # Marketable harvest (total biomass times fraction marketable size)
    opt.df[k,7] = op$B[op$profit==max_profit]     # Prawn size at harvest
    opt.df[k,8] = op$P[op$profit==max_profit] / start["P"]   # Prawn % survival at harvest
    opt.df[k,9] = op$revenue[op$profit==max_profit]    # Raw revenue generated
    opt.df[k,10] = max_profit  #Net profit
    opt.df[k,11] = op$roi[op$profit==max_profit] # ROI  
    
  }

opt.df$p.t = opt.df$P_nought * opt.df$p.surv     #number of prawns alive at harvest
opt.df$Species = "M. volenhovenii"
  opt.df.criteria = subset(opt.df, p.bm >=30 & h.t <= 365)
  opt.vol = opt.df[which(opt.df$Profit == max(opt.df$Profit)),]
  opt.vol$bm0 = 10^par.aqua['a.p']*(opt.vol$L_nought/10)^par.aqua['b.p'] * opt.vol$P_nought

#Simulation for eumetric curve for M. rosenbergii #####
opt.df.ros = opt.df
  opt.df.ros$h.t = 0
  opt.df.ros$h.bm = 0
  opt.df.ros$h.frac = 0
  opt.df.ros$m.bm = 0
  opt.df.ros$p.bm = 0
  opt.df.ros$p.surv = 0
  opt.df.ros$Revenue = 0
  opt.df.ros$Profit = 0
  opt.df.ros$ROI = 0
  
  par.aqua['k'] = k.ros    # alternate value for M. rosenbergii, from Sampaio & Valenti 1996: 0.0104333333
  
  for(k in 1:nrow(opt.df.ros)){
    start = c(P = opt.df.ros[k,2], L = opt.df.ros[k,1])
    market_frac = predict(eta.lm, newdata = data.frame(dens = start["P"]/area))

  #Run model with above starting conditions  
    op = as.data.frame(ode(start,t.p,prawn_biomass,par.aqua))
    
  #Estimate additional values for simulation  
    op$B = 10^par.aqua['a.p']*(op$L/10)^par.aqua['b.p']     # Mean prawn biomass, transformed from length in mm
    op$Bt = op$P*op$B #Total biomass in grams of prawn population
    op$harvest_mass = op$Bt * market_frac   #harvest biomass estimated as total biomass times marketable fraction
    op$revenue = (op$harvest_mass/1000)*p    #revenue generated by harvest
    op$profit = op$revenue*exp(-delta*op$time) - cost*(start["P"])   #profit generated by harvest
    op$roi = op$profit / (cost*(start["P"]))
    
  #Store parameters of optimal management  
    max_profit = max(op$profit)
    
    opt.df.ros[k,3] = op$time[op$profit==max_profit]  # harvest time
    opt.df.ros[k,4] = op$Bt[op$profit==max_profit]    # Total prawn biomass
    opt.df.ros[k,5] = market_frac # Fraction of harvest that's marketable as function of stocking density
    opt.df.ros[k,6] = opt.df.ros[k,4] * opt.df.ros[k,5]           # Marketable harvest (total biomass times fraction marketable size)
    opt.df.ros[k,7] = op$B[op$profit==max_profit]     # Prawn size at harvest
    opt.df.ros[k,8] = op$P[op$profit==max_profit] / start["P"]   # Prawn % survival at harvest
    opt.df.ros[k,9] = op$revenue[op$profit==max_profit]    # Raw revenue generated
    opt.df.ros[k,10] = max_profit  #Net profit
    opt.df.ros[k,11] = op$roi[op$profit==max_profit] # ROI  
    
  }
 
opt.df.ros$p.t = opt.df.ros$P_nought * opt.df.ros$p.surv     #number of prawns alive at harvest
opt.df.ros$Species = "M. rosenbergii"
  opt.df.ros.criteria = subset(opt.df.ros, p.bm >=30 & h.t <= 365)
  opt.ros = opt.df.ros[which(opt.df.ros$Profit == max(opt.df.ros$Profit)),]
  opt.ros$bm0 = 10^par.aqua['a.p']*(opt.ros$L_nought/10)^par.aqua['b.p'] * opt.ros$P_nought

eum_dat <- rbind(opt.df, opt.df.ros)  

```

```{r Fig2_Prep, warning=FALSE, include=FALSE, cache = TRUE}

sim_aqua <- function(P0, species = "M. vollenhovenii"){
  
#Set starting parameters based on stocking density  
  sim_start = c(P = P0, L = 40)

#Get marketable fraction of harvest as function of stocking density    
  market_frac = predict(eta.lm, newdata = data.frame(dens = P0/area))
  
#Set growth rate based on species  
  if(species == "M. vollenhovenii"){
    par.aqua['k'] = k.vol
  } else {
    par.aqua['k'] = k.ros
  }
  
#Simulate for two years  
  sim_df <- as.data.frame(ode(sim_start,t.p,prawn_biomass,par.aqua))
  
  #Estimate additional values for simulation  
    sim_df$P_dens = sim_df$P / area
    sim_df$B = 10^(par.aqua['a.p']+par.aqua['b.p']*log10(sim_df$L/10))     # Mean prawn biomass, transformed from length in mm
    sim_df$Bt = sim_df$P*sim_df$B /1000 #Total biomass in kilograms of prawn population
    sim_df$harvest_mass = sim_df$Bt * market_frac   #harvest biomass estimated as total biomass times marketable fraction
    sim_df$revenue = (sim_df$harvest_mass)*p    #revenue generated by harvest
    sim_df$profit = sim_df$revenue*exp(-delta*sim_df$time) - cost*(sim_start["P"])   #profit generated by harvest
    sim_df$roi = sim_df$profit / (cost*(sim_start["P"]))
    sim_df$species = species
    sim_df$P0 = P0 / area
    
  return(as.matrix(sim_df))  

}
  
test_p0s <- seq(500, 7500, 1000)  

aqua_sims_vol <- do.call(rbind, lapply(test_p0s, sim_aqua))
aqua_sims_ros <- do.call(rbind, lapply(test_p0s, sim_aqua, species = "M. rosenbergii"))

aqua_sims = as.data.frame(rbind(aqua_sims_vol, aqua_sims_ros)) %>% 
  gather(key = "Variable", value = "Value", P:roi)

```

```{r Fig2, echo=FALSE, fig.height=10.5, fig.width=8}
  aqua_sims %>% mutate(time = as.numeric(time),
                       Value = as.numeric(Value)) %>% 
    filter(Variable %in% c("P_dens", "L", "harvest_mass", "profit")) %>% 
    mutate(Variable = case_when(Variable == "P_dens" ~ "Density (P)",
                                Variable == "L" ~ "Mean Length (mm)",
                                Variable == "harvest_mass" ~ "Harvestable biomass (kg)",
                                Variable == "profit" ~ "Profit (USD)")) %>% 
    ggplot(aes(x = time, y = Value, col = P0)) +
      geom_line(size = 1.25) +
      scale_color_manual(name = expression(P[0]),
                         values = c("gray90", "grey80", "red",
                                    "gray60", "gray50", "gray40",
                                    "gray30", "gray20")) +
      facet_grid(Variable ~ species, scales = "free_y", switch = "y") +
      theme_bw() + 
      theme(axis.text = element_text(size = 12),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 15),#increase legend text size
            strip.text = element_text(size = 14))

```

# Figure 3: Eumetric curves   

```{r Fig3, echo=FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
  eum_crv = ggplot(eum_dat, aes(x = P_nought/1000)) +
              theme_bw() +
              theme(legend.position = c(0.2, 0.1),        #place legend inside plot
                    axis.text = element_text(size = 15),  #increase axis label size
                    axis.title = element_text(size = 18), #increase axis title size
                    legend.text = element_text(size = 12),#increase legend text size
                    axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                    axis.text.x = element_blank(),
                    legend.title = element_blank())  +    #suppress legend title
              geom_line(aes(y = Profit, col = Species), size = 1.25) +
              scale_color_manual(values = c("red", "blue")) +
              geom_hline(yintercept = 0, aes(col = grey20)) +
              annotate("text", x = 0, y = 750, label = "A)", size = 8) +
              labs(x = expression(paste('Stocking density (', P[0],')', sep = "")), 
                   y = expression(paste('Profit (', Pi[max], ')', sep = "")))  +
              scale_y_continuous(limits = c(-500, 750),
                                 breaks = seq(-500, 750, 250)) +
              scale_x_continuous(limits = c(0, 8),
                                 breaks = c(0, 2, 4, 6, 8))  
    
eum_time = ggplot(eum_dat, aes(x = P_nought/1000)) +
            theme_bw() +
            theme(legend.position = 'none',        #place legend inside plot
                  axis.text = element_text(size = 15),  #increase axis label size
                  axis.title = element_text(size = 18), #increase axis title size
                  legend.text = element_text(size = 12),#increase legend text size
                  legend.title = element_blank())  +    #suppress legend title
            geom_line(aes(y = h.t, col = Species), size = 1.25) +
            annotate("text", x = 0, y = 365, label = "B)", size = 8) +
            scale_color_manual(values = c("red", "blue")) +
            labs(x = expression(paste('Stocking density (', P[0],')', sep = "")), 
                 y = expression(paste('Harvest time (', T[opt]^sp, ')', sep = "")))  +
            scale_y_continuous(limits = c(0, 365),
                               breaks = c(0,60,120,180,240,300,365)) +
            scale_x_continuous(limits = c(0, 8),
                               breaks = c(0, 2, 4, 6, 8))  


  
  eum.layout = matrix(c(1,2), ncol = 1, byrow = T)

  multiplot(eum_crv, eum_time, layout = eum.layout)

```

We want to add estimates of uncertainty to the eumetric curve in addition to the eumetric curve generated by point estimates of all parameters (above). We'll use the same parameter sets from the latin hypercube generated for the PRCC sensitivity analysis to run the model over all tested stocking densities 

```{r Fig3_sensitivity, include=FALSE, cache = TRUE}
source("Sensitivity_Analysis/sensitivity_prep.R")

# Get aquaculture parameters from LHC
  lhcpars.aqua = lhcpars[,which(colnames(lhcpars) %in% c(names(par.aqua), 'k.ros', 'c', 'p', 'delta'))]
  
# Get the stocking densities and starting length again
  test_starts <- expand.grid(L_nought = 40, P_nought = seq(500, 7500, 100))
  
#Function from stack overflow (https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames)  
  expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...))

  eum_sim <- expand.grid.df(lhcpars.aqua, test_starts)
  
# Modify sim_aqua function from above to run through eum_sim data frame and return harvest time and profit  
  sim_aqua_eum <- function(a.p, b.p, gam, muP, d, om, k, linf, k.ros, c, p, delta, L_nought, P_nought, species){
  
  #Set starting parameters based on stocking density  
    sim_start = c(P = P_nought, L = L_nought)
  
  #Get marketable fraction of harvest as function of stocking density    
    market_frac = predict(eta.lm, newdata = data.frame(dens = P_nought/area))
    
  # Set parameters from row of eum_sim
    # Set growth rate based on species  
      if(species == "M. vollenhovenii"){
        par.aqua['k'] = k
      } else {
        par.aqua['k'] = k.ros
      }

      par.aqua['a.p'] <- a.p
      par.aqua['b.p'] <- b.p
      par.aqua['gam'] <- gam
      par.aqua['muP'] <- muP
      par.aqua['d'] <- d
      par.aqua['om'] <- om
      par.aqua['linf'] <- linf
      
      cost <- c
      price <- p
      delt <- delta
    
  #Simulate for two years  
    sim_df <- as.data.frame(ode(sim_start,t.p,prawn_biomass,par.aqua)) %>% 
      mutate(B = 10^(a.p+b.p*log10(L/10)),     # Mean prawn biomass, transformed from length in mm)
             Bt = (P*B) /1000, #Total biomass in kilograms of prawn population     
             harvest_mass = Bt * market_frac,
             revenue = harvest_mass*price,
             profit = revenue*exp(-delt*time) - cost*P_nought)
    
    max_prof <- max(sim_df$profit)
    harvest_time <- sim_df$time[which(sim_df$profit == max_prof)]
    
  # print(c(par.aqua, cost, price, max_prof, harvest_time))
  return(data.frame("Profit" = max_prof, "Harvest_time" = harvest_time, "Species" = species)) 

}

  eum_sims_vol <- eum_sim %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii"))
    eum_sims_vol$par_set <- rep(1:nsims, nrow(test_starts))   #Add identifier for unique parameter sets
    
    eum_sims_vol_sum <- eum_sims_vol %>%       #Summarise across parameter sets
      group_by(P_nought) %>%  
      summarise(Profit_Med = median(Profit),
                Profit_min = min(Profit),
                Profit_max = max(Profit),
                Profit_upq = quantile(Profit, 0.75),
                Profit_loq = quantile(Profit, 0.25),
                Harvest_time_med = median(Harvest_time),
                Harvest_time_upq = quantile(Harvest_time, 0.75),
                Harvest_time_loq = quantile(Harvest_time, 0.25),
                Species = unique(Species),
                n_par_sets = n())
    
  eum_sims_ros <- eum_sim %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii"))
    eum_sims_ros$par_set <- rep(1:nsims+nsims, nrow(test_starts))   #Add identifier for unique parameter sets
  
    eum_sims_ros_sum <- eum_sims_ros %>%       #Summarise across parameter sets
      group_by(P_nought) %>%  
      summarise(Profit_Med = median(Profit),
                Profit_min = min(Profit),
                Profit_max = max(Profit),
                Profit_upq = quantile(Profit, 0.75),
                Profit_loq = quantile(Profit, 0.25),
                Harvest_time_med = median(Harvest_time),
                Harvest_time_upq = quantile(Harvest_time, 0.75),
                Harvest_time_loq = quantile(Harvest_time, 0.25),
                Species = unique(Species),
                n_par_sets = n())
  
    
  eum_sims_all_sum = as.data.frame(rbind(eum_sims_vol_sum, eum_sims_ros_sum)) %>% 
    mutate(Species = factor(Species, levels = c("M. rosenbergii", "M. vollenhovenii")))

```

```{r Fig3_with_uncertainty, echo=FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
  eum_crv2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = Profit_Med, col = Species)) + 
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = Profit_loq, ymax = Profit_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = c(0.2, 0.1),        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.title = element_blank())  +    #suppress legend title
      scale_color_manual(values = c("red", "blue")) +
      geom_hline(yintercept = 0, aes(col = grey20)) +
      annotate("text", x = 0, y = 750, label = "A)", size = 8) +
      labs(x = expression(paste('Stocking density (', P[0],')', sep = "")), 
           y = expression(paste('Profit (', Pi[max], ')', sep = "")))  +
      #scale_y_continuous(limits = c(-500, 750),
      #                   breaks = seq(-500, 750, 250)) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  
    
eum_time2 = eum_sims_all_sum %>% 
  ggplot(aes(x = P_nought/1000, y = Harvest_time_med, col = Species)) +
    geom_line(size = 1.25) +
    geom_ribbon(aes(x = P_nought/1000, ymin = Harvest_time_loq, ymax = Harvest_time_upq, fill = Species), alpha = 0.3, size = 0) +
    theme_bw() +
    theme(legend.position = 'none',    
          axis.text = element_text(size = 15),  #increase axis label size
          axis.title = element_text(size = 18), #increase axis title size
          legend.text = element_text(size = 12),#increase legend text size
          legend.title = element_blank())  +    #suppress legend title
    annotate("text", x = 0, y = 365, label = "B)", size = 8) +
    scale_color_manual(values = c("red", "blue")) +
    labs(x = expression(paste('Stocking density (', P[0],')', sep = "")), 
         y = expression(paste('Harvest time (', T[opt]^sp, ')', sep = "")))  +
    #scale_y_continuous(limits = c(0, 365),
    #                   breaks = c(0,60,120,180,240,300,365)) +
    scale_x_continuous(limits = c(0, 8),
                       breaks = c(0, 2, 4, 6, 8))  

  eum.layout = matrix(c(1,2), ncol = 1, byrow = T)

  multiplot(eum_crv2, eum_time2, layout = eum.layout)
```



