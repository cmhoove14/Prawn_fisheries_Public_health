---
title: "Full Analysis"
author: "Chris Hoover"
date: "August 22, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(deSolve)
require(sensitivity)
require(parallel)
require(kableExtra)
require(tidyverse)

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
    library(grid)
    
    # Make a list from the ... arguments and plotlist
    plots <- c(list(...), plotlist)
    
    numPlots = length(plots)
    
    # If layout is NULL, then use 'cols' to determine layout
    if (is.null(layout)) {
      # Make the panel
      # ncol: Number of columns of plots
      # nrow: Number of rows needed, calculated from # of cols
      layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                       ncol = cols, nrow = ceiling(numPlots/cols))
    }
    
    if (numPlots==1) {
      print(plots[[1]])
      
    } else {
      # Set up the page
      grid.newpage()
      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
      
      # Make each plot, in the correct location
      for (i in 1:numPlots) {
        # Get the i,j matrix positions of the regions that contain this subplot
        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
        
        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                        layout.pos.col = matchidx$col))
      }
    }
  }

#Function from stack overflow (https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames)  
  expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...))

# Number of years to simulate
  years = 10
  
```

# Numeric estimation of max profit  
For each prawn species, shows trajectories of length, density, harvestable biomass, and profit over time over a range of stocking densities

```{r Opt_stock, include=FALSE, cache = TRUE}
source('Prawn_aquaculture/prawn_aquaculture_mod.R')
source('Prawn_aquaculture/prawn_aquaculture_sim.R')

#Simulation for eumetric curve for M. volenhovenii #####
#Starting length of 40 mm corresponds to juveniles of ~0.35 grams
opt.df = expand.grid.df(data.frame(t(par.aqua), c = cost, p = price, delta = delta), 
                        data.frame(L_nought = 40, P_nought = seq(500, 7500, 100))) 

#Get mgmt strategy that maximizes cumulative ten year profits
opt.vol.df <- opt.df %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii"))
  opt.vol <- opt.vol.df %>% filter(cum_profits == max(cum_profits))
opt.ros.df <- opt.df %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii"))
  opt.ros <- opt.ros.df %>% filter(cum_profits == max(cum_profits))

eum_dat <- rbind(opt.vol.df, opt.ros.df)  

```

```{r Fig2_Prep, warning=FALSE, include=FALSE, cache = TRUE}
  
test_p0s <- seq(500, 7500, 1000)  

aqua_sims_vol <- do.call(rbind, lapply(test_p0s, sim_aqua_time))
aqua_sims_ros <- do.call(rbind, lapply(test_p0s, sim_aqua_time, species = "M. rosenbergii"))

aqua_sims = as.data.frame(rbind(aqua_sims_vol, aqua_sims_ros)) %>% 
  mutate(n_harvest = ifelse(as.numeric(as.character(p_mass)) >= 30, as.numeric(as.character(n_harvest)), NA)) %>% 
  gather(key = "Variable", value = "Value", P_dens, L, harvest_mass, profit, n_harvest, cum_profits)

```

```{r Fig2, echo=FALSE, fig.height=10.5, fig.width=8}
  aqua_sims %>% mutate(time = as.numeric(time),
                       Value = as.numeric(Value)) %>% 
    filter(Variable %in% c("P_dens", "L", "n_harvest", "profit")) %>% 
    mutate(Variable = case_when(Variable == "P_dens" ~ "Density (P)",
                                Variable == "L" ~ "Average Length (mm)",
                                Variable == "n_harvest" ~ "Number of harvests",
                                Variable == "profit" ~ "Profit (USD)")) %>% 
    ggplot(aes(x = time, y = Value, col = P_nought)) +
      geom_line(size = 1.25) +
      scale_color_manual(name = expression(P[0]),
                         values = c("gray90", "gray80", "red",
                                    "gray60", "gray50", "gray40",
                                    "gray30", "gray20")) +
      facet_grid(Variable ~ Species, scales = "free_y", switch = "y") +
      theme_bw() + 
      theme(axis.text = element_text(size = 12),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 15),#increase legend text size
            strip.text = element_text(size = 14))

```

# Eumetric curves   

```{r Fig3, echo=FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
  eum_crv = ggplot(eum_dat, aes(x = P_nought/1000)) +
              theme_bw() +
              theme(legend.position = c(0.2, 0.1),        #place legend inside plot
                    axis.text = element_text(size = 15),  #increase axis label size
                    axis.title = element_text(size = 18), #increase axis title size
                    legend.text = element_text(size = 12),#increase legend text size
                    axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                    axis.text.x = element_blank(),
                    legend.title = element_blank())  +    #suppress legend title
              geom_line(aes(y = cum_profits/1000, col = Species), size = 1.25) +
              scale_color_manual(values = c("red", "blue")) +
              geom_hline(yintercept = 0, aes(col = grey20)) +
              annotate("text", x = 0, y = max(eum_dat$cum_profits), label = "A)", size = 8) +
              labs(y = expression(paste('10-Year Profits, ', CP^sp, ' (1000s USD)', sep = "")))  +
              scale_y_continuous(limits = c(min(eum_dat$cum_profits), 12500)/1000,
                                 breaks = seq(-2.500, 12.500, 2.500)) +
              scale_x_continuous(limits = c(0, 8),
                                 breaks = c(0, 2, 4, 6, 8))  
 
  prf_crv = ggplot(eum_dat, aes(x = P_nought/1000)) +
              theme_bw() +
              theme(legend.position = 'none',        #place legend inside plot
                    axis.text = element_text(size = 15),  #increase axis label size
                    axis.title = element_text(size = 18), #increase axis title size
                    legend.text = element_text(size = 12),#increase legend text size
                    axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                    axis.text.x = element_blank(),
                    legend.title = element_blank())  +    #suppress legend title
              geom_line(aes(y = profit, col = Species), size = 1.25) +
              scale_color_manual(values = c("red", "blue")) +
              geom_hline(yintercept = 0, aes(col = grey20)) +
              annotate("text", x = 0, y = max(eum_dat$profit), label = "B)", size = 8) +
              labs(y = expression(paste('Profit per cycle (USD)', sep = "")))  +
              scale_y_continuous(limits = c(-400, 410),
                                 breaks = seq(-400, 400, 200)) +
              scale_x_continuous(limits = c(0, 8),
                                 breaks = c(0, 2, 4, 6, 8))  

   
eum_time = ggplot(eum_dat, aes(x = P_nought/1000)) +
            theme_bw() +
            theme(legend.position = 'none',        #place legend inside plot
                  axis.text = element_text(size = 15),  #increase axis label size
                  axis.title = element_text(size = 18), #increase axis title size
                  axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                  axis.text.x = element_blank(),
                  legend.text = element_text(size = 12),#increase legend text size
                  legend.title = element_blank())  +    #suppress legend title
            geom_line(aes(y = time, col = Species), size = 1.25) +
            annotate("text", x = 0, y = 365, label = "C)", size = 8) +
            scale_color_manual(values = c("red", "blue")) +
            labs(y = expression(paste('Harvest time, ', T[opt]^sp, ' (days)', sep = "")))  +
            scale_y_continuous(limits = c(0, 365),
                               breaks = c(0,60,120,180,240,300,365)) +
            scale_x_continuous(limits = c(0, 8),
                               breaks = c(0, 2, 4, 6, 8))  

eum_harvests = ggplot(eum_dat, aes(x = P_nought/1000)) +
            theme_bw() +
            theme(legend.position = 'none',        #place legend inside plot
                  axis.text = element_text(size = 15),  #increase axis label size
                  axis.title = element_text(size = 18), #increase axis title size
                  legend.text = element_text(size = 12),#increase legend text size
                  legend.title = element_blank())  +    #suppress legend title
            geom_line(aes(y = n_harvest, col = Species), size = 1.25) +
            annotate("text", x = 0, y = 25, label = "D)", size = 8) +
            scale_color_manual(values = c("red", "blue")) +
            labs(x = expression(paste('Stocking density, ', P[0],' (', Pm^-2, ")", sep = "")), 
                 y = "Harvests per 10 years")  +
            scale_y_continuous(limits = c(0, 30),
                               breaks = c(0,10,20,30),
                               labels = c("0", "10", "20", "  30")) +
            scale_x_continuous(limits = c(0, 8),
                               breaks = c(0, 2, 4, 6, 8))  


  
  eum.layout = matrix(c(1,2,3), ncol = 1, byrow = T)

  multiplot(eum_crv, prf_crv, eum_harvests, layout = eum.layout)

```

We want to add estimates of uncertainty to the eumetric curve in addition to the eumetric curve generated by point estimates of all parameters (above). We'll use the same parameter sets from the latin hypercube generated for the PRCC sensitivity analysis to run the model over all tested stocking densities 

```{r Fig3_sensitivity, include=FALSE, cache = TRUE}
source("Sensitivity_Analysis/sensitivity_prep.R")

# Get aquaculture parameters from LHC
  lhcpars.aqua = lhcpars[,which(colnames(lhcpars) %in% c(names(par.aqua), 'k.ros', 'c', 'p', 'delta'))]
  
# Get the stocking densities and starting length again
  test_starts <- expand.grid(L_nought = 40, P_nought = seq(500, 7500, 100))
  
  eum_sim <- expand.grid.df(lhcpars.aqua, test_starts)
  
  eum_sims_vol <- eum_sim %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii"))
    eum_sims_vol$par_set <- rep(1:nsims, nrow(test_starts))   #Add identifier for unique parameter sets
    
    eum_sims_vol_sum <- eum_sims_vol %>%       #Summarise across parameter sets
      group_by(P_nought) %>%  
      summarise(Profit_Cycle_Med = median(profit),
                Profit_Cycle_upq = quantile(profit, 0.75),
                Profit_Cycle_loq = quantile(profit, 0.25),
                cum_Profit_Med = median(cum_profits),
                cum_Profit_min = min(cum_profits),
                cum_Profit_max = max(cum_profits),
                cum_Profit_upq = quantile(cum_profits, 0.75),
                cum_Profit_loq = quantile(cum_profits, 0.25),
                Harvest_time_med = median(time),
                Harvest_time_upq = quantile(time, 0.75),
                Harvest_time_loq = quantile(time, 0.25),
                n_harvest_med = median(n_harvest),
                n_harvest_upq = quantile(n_harvest, 0.75),
                n_harvest_loq = quantile(n_harvest, 0.25),
                Species = unique(Species),
                n_par_sets = n())
    
  eum_sims_ros <- eum_sim %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii"))
    eum_sims_ros$par_set <- rep(1:nsims+nsims, nrow(test_starts))   #Add identifier for unique parameter sets
  
    eum_sims_ros_sum <- eum_sims_ros %>%       #Summarise across parameter sets
      group_by(P_nought) %>%  
      summarise(Profit_Cycle_Med = median(profit),
                Profit_Cycle_upq = quantile(profit, 0.75),
                Profit_Cycle_loq = quantile(profit, 0.25),
                cum_Profit_Med = median(cum_profits),
                cum_Profit_min = min(cum_profits),
                cum_Profit_max = max(cum_profits),
                cum_Profit_upq = quantile(cum_profits, 0.75),
                cum_Profit_loq = quantile(cum_profits, 0.25),
                Harvest_time_med = median(time),
                Harvest_time_upq = quantile(time, 0.75),
                Harvest_time_loq = quantile(time, 0.25),
                n_harvest_med = median(n_harvest),
                n_harvest_upq = quantile(n_harvest, 0.75),
                n_harvest_loq = quantile(n_harvest, 0.25),
                Species = unique(Species),
                n_par_sets = n())
  
    
  eum_sims_all_sum = as.data.frame(rbind(eum_sims_vol_sum, eum_sims_ros_sum)) %>% 
    mutate(Species = factor(Species, levels = c("M. rosenbergii", "M. vollenhovenii")))

```

```{r Fig3_with_uncertainty, echo=FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
  eum_crv2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = cum_Profit_Med/1000, col = Species)) + 
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = cum_Profit_loq/1000, ymax = cum_Profit_upq/1000, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = c(0.2, 0.095),        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.title = element_blank())  +    #suppress legend title
      scale_color_manual(values = c("red", "blue")) +
      geom_hline(yintercept = 0, aes(col = grey20)) +
      annotate("text", x = 0, y = 12.5, label = "A)", size = 8) +
      labs(y = expression(paste('10-Year Profits', ' (1000s USD)', sep = "")))  +
      scale_y_continuous(limits = c(-3000, 12750)/1000,
                         breaks = seq(-2.500, 12.500, 2.500)) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  

  prf_crv2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = Profit_Cycle_Med, col = Species)) + 
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = Profit_Cycle_loq, ymax = Profit_Cycle_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = "none",        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.title = element_blank())  +    #suppress legend title
      scale_color_manual(values = c("red", "blue")) +
      geom_hline(yintercept = 0, aes(col = grey20)) +
      annotate("text", x = 0, y = 500, label = "B)", size = 8) +
      labs(y = expression(paste('Profit per cycle (USD)', sep = "")))  +
      scale_y_continuous(limits = c(-525, 550),
                         breaks = seq(-500, 500, 250)) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  


  eum_time2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = Harvest_time_med, col = Species)) +
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = Harvest_time_loq, ymax = Harvest_time_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = 'none',    
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.text = element_text(size = 12),#increase legend text size
            legend.title = element_blank())  +    #suppress legend title
      annotate("text", x = 0, y = 365, label = "B)", size = 8) +
      scale_color_manual(values = c("red", "blue")) +
      labs(expression(paste('Harvest time, ', T[opt]^sp, ' (days)', sep = "")))  +
      scale_y_continuous(limits = c(0, 365),
                         breaks = c(0,60,120,180,240,300,365)) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  

  eum_harvests2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = n_harvest_med, col = Species)) +
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = n_harvest_loq, ymax = n_harvest_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = 'none',        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            legend.title = element_blank())  +    #suppress legend title
      annotate("text", x = 0, y = 30, label = "C)", size = 8) +
      scale_color_manual(values = c("red", "blue")) +
      labs(x = expression(paste('Stocking density, ', P[0],' (', Pm^-2, ")", sep = "")), 
           y = "Harvests per 10 years")  +
      scale_y_continuous(limits = c(0, 30),
                         breaks = c(0,10,20,30),
                         labels = c("   0", "  10", "  20", "  30")) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  

  eum_crv2

  multiplot(eum_crv2, prf_crv2, eum_harvests2, layout = eum.layout)
```

# Optimal management table  

Also want a table showing set of parameters and outputs from "optimal management"

```{r op_mgmt_table, echo=FALSE, cache = TRUE}
  vol_op_mgmt <- expand.grid.df(lhcpars.aqua, expand.grid(L_nought = opt.vol$L_nought, P_nought = opt.vol$P_nought)) %>% 
    bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii")) %>% group_by(P_nought, L_nought) %>% 
    summarise(#biomass0 = P_nought * (10^(a.p+b.p*log10(L_nought/10))),
              harvest_time_med = median(time),
              harvest_time_loq = quantile(time, 0.25),
              harvest_time_upq = quantile(time, 0.75),
              harvest_mass_med = median(harvest_mass),
              harvest_mass_loq = quantile(harvest_mass, 0.25),
              harvest_mass_upq = quantile(harvest_mass, 0.75),
              harvest_length_med = median(L),
              harvest_length_loq = quantile(L, 0.25),
              harvest_length_upq = quantile(L, 0.75),
              harvest_number_med = median(P),
              harvest_number_loq = quantile(P, 0.25),
              harvest_number_upq = quantile(P, 0.75),
              profit_cycle_med = median(profit),
              profit_cycle_loq = quantile(profit, 0.25),
              profit_cycle_upq = quantile(profit, 0.75),
              roi_med = median(roi),
              roi_loq = quantile(roi, 0.25),
              roi_upq = quantile(roi, 0.75),
              n_harvest_med = median(n_harvest),
              n_harvest_loq = quantile(n_harvest, 0.25),
              n_harvest_upq = quantile(n_harvest, 0.75),
              cum_profit_med = median(cum_profits),
              cum_profit_loq = quantile(cum_profits, 0.25),
              cum_profit_upq = quantile(cum_profits, 0.75)) %>% 
  knitr::kable(digits = 3)

  ros_op_mgmt <- expand.grid.df(lhcpars.aqua, expand.grid(L_nought = opt.ros$L_nought, P_nought = opt.ros$P_nought)) %>% 
    bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii")) %>% group_by(P_nought, L_nought) %>% 
    summarise(#biomass0 = P_nought * (10^(a.p+b.p*log10(L_nought/10))),
              harvest_time_med = median(time),
              harvest_time_loq = quantile(time, 0.25),
              harvest_time_upq = quantile(time, 0.75),
              harvest_mass_med = median(harvest_mass),
              harvest_mass_loq = quantile(harvest_mass, 0.25),
              harvest_mass_upq = quantile(harvest_mass, 0.75),
              harvest_length_med = median(L),
              harvest_length_loq = quantile(L, 0.25),
              harvest_length_upq = quantile(L, 0.75),
              harvest_number_med = median(P),
              harvest_number_loq = quantile(P, 0.25),
              harvest_number_upq = quantile(P, 0.75),
              profit_cycle_med = median(profit),
              profit_cycle_loq = quantile(profit, 0.25),
              profit_cycle_upq = quantile(profit, 0.75),
              roi_med = median(roi),
              roi_loq = quantile(roi, 0.25),
              roi_upq = quantile(roi, 0.75),
              n_harvest_med = median(n_harvest),
              n_harvest_loq = quantile(n_harvest, 0.25),
              n_harvest_upq = quantile(n_harvest, 0.75),
              cum_profit_med = median(cum_profits),
              cum_profit_loq = quantile(cum_profits, 0.25),
              cum_profit_upq = quantile(cum_profits, 0.75)) %>% 
  knitr::kable(digits = 3)

```


**Parameter**                     **Definition**                      *M. vollenhovenii*                          *M. rosenbergii*
--------------------              --------------------------------    ----------------------     ------------------------------------------
${P_0}_{opt}^{sp}$                Optimal stocking density             `r opt.vol$P_nought/area` $Pm^{-2}$                  `r opt.ros$P_nought/area` $Pm^{-2}$
$L_0$                             Mean length at stocking              `r opt.vol$L_nought` $mm$                            `r opt.ros$L_nought` $mm$
$\Omega(t_0)$                     Total biomass at stocking            `r round(opt.vol$bm0/1000, 2)` $kg$                  `r round(opt.ros$bm0/1000, 2)` $kg$
$T_{opt}^{sp}$                    Optimal harvest time                 `r opt.vol$h.t` $days$                               `r opt.ros$h.t` $days$
$Y(T_{opt}^{sp},{P_0}_{opt}^{sp})$   Commercial yield                  `r round(opt.vol$m.bm/1000, 2)` $kg$                 `r round(opt.ros$m.bm/1000, 2)` $kg$
$L(T_{opt}^{sp})$   Mean length at harvest                  `r round(opt.vol$m.bm/1000, 2)` $kg$                 `r round(opt.ros$m.bm/1000, 2)` $kg$
--------------------              --------------------------------    ----------------------     ------------------------------------------

# Epi simulations  

```{r snail_prep, include=FALSE, cache = TRUE}
source("Combined_Model/epi_no_diag_prawn_immigration_mod.R")

## Set initial values and parameters ###########
years = 10   #number of years to simulate
t.all = c(0:(years*2*365)+366)  #total time vector

#Volenhovenii stocking and harvesting events ###########
nstart.vol = c(S1 = allvh.eqbm.imm$S1, S2 = allvh.eqbm.imm$S2, S3 = allvh.eqbm.imm$S3, 
               E1 = allvh.eqbm.imm$E1, E2 = allvh.eqbm.imm$E2, E3 = allvh.eqbm.imm$E3, 
               I1 = allvh.eqbm.imm$I1, I2 = allvh.eqbm.imm$I2, I3 = allvh.eqbm.imm$I3, 
               Wt = allvh.eqbm.imm$Wt, Wu = allvh.eqbm.imm$Wu, 
               P = opt.vol$P_nought, L = opt.vol$L_nought) #Optimal stocking parameters from volenhovenii profit optimization above

#Create data frame representing stocking and harvesting events for M. vollenhovenii
  harvest.t.vol = opt.vol$time           #Optimal harvest time from volenhovenii optimization
  n.harvest.vol = floor((years*365)/harvest.t.vol)
  stocks.vol = data.frame(var = rep(c('P', 'L'), n.harvest.vol+1),
                          time = rep(366 + harvest.t.vol*c(0:n.harvest.vol), each = 2),
                          value = rep(c(nstart.vol['P'], nstart.vol['L']), n.harvest.vol+1),
                          method = rep('rep', (n.harvest.vol+1)*2))
  
    vol.harvests = stocks.vol[seq(1, nrow(stocks.vol), 2), 2]  
#Remove all prawns after ten years of intervention  
  vol_rmv <- data.frame(var = c("P", "L"),
                        time = rep(years*365+366, 2),
                        value = c(1e-6,1e-6),
                        method = rep('rep', 2))
  
  stocks.vol <- rbind(stocks.vol, vol_rmv)
  
  par.all.vol = c(par.aqua, par.snails.imm,
                  eps = 10,   # Attack rate penalty 
                  a.s = 0.187178454,  # Allometric parameter for snail length-weight relationship, fitted to Sanna's data on B. glabrata
                  b.s = 2.536764792,  # Allometric parameter for snail length-weight relationship, fitted to Sanna's data on B. glabrata
                  ar.slp = 0.9050,    # Coefficient for relationship between biomass ratio and attack rate, fitted to data from Sokolow et al. 2014
                  th = 0.38561)       # Coefficient for relationship between biomass ratio and handling time, fitted to data from Sokolow et al. 2014
  
  par.all.vol['k'] <- k.vol
#Rosenbergii stocking and harvesting events ###########
nstart.ros = c(S1 = allvh.eqbm.imm$S1, S2 = allvh.eqbm.imm$S2, S3 = allvh.eqbm.imm$S3, 
               E1 = allvh.eqbm.imm$E1, E2 = allvh.eqbm.imm$E2, E3 = allvh.eqbm.imm$E3, 
               I1 = allvh.eqbm.imm$I1, I2 = allvh.eqbm.imm$I2, I3 = allvh.eqbm.imm$I3, 
               Wt = allvh.eqbm.imm$Wt, Wu = allvh.eqbm.imm$Wu, 
               P = opt.ros$P_nought, L = opt.ros$L_nought) #Optimal stocking parameters from volenhovenii ROI optimization

#Create dataframe represnting stocking and harvesting of M. rosenbergii prawns  
  harvest.t.ros = opt.ros$time
  n.harvest.ros = floor((years*365)/harvest.t.ros)
  stocks.ros = data.frame(var = rep(c('P', 'L'), n.harvest.ros+1),
                          time = rep(366 + harvest.t.ros*c(0:n.harvest.ros), each = 2),
                          value = rep(c(nstart.ros['P'], nstart.ros['L']), n.harvest.ros+1),
                          method = rep('rep', (n.harvest.ros+1)*2))
  
    ros.harvests = stocks.ros[seq(1, nrow(stocks.ros), 2), 2]
  
#Remove all prawns after ten years of intervention  
  ros_rmv <- data.frame(var = c("P", "L"),
                        time = rep(years*365+366, 2),
                        value = c(1e-6,1e-6),
                        method = rep('rep', 2))
  
  stocks.ros <- rbind(stocks.ros, ros_rmv)

  par.all.ros = c(par.aqua, par.snails.imm,
                  eps = 10,   # Attack rate penalty 
                  a.s = 0.187178454,  # Allometric parameter for snail length-weight relationship, fitted to Sanna's data on B. glabrata
                  b.s = 2.536764792,  # Allometric parameter for snail length-weight relationship, fitted to Sanna's data on B. glabrata
                  ar.slp = 0.9050,    # Coefficient for relationship between biomass ratio and attack rate, fitted to data from Sokolow et al. 2014
                  th = 0.38561)       # Coefficient for relationship between biomass ratio and handling time, fitted to data from Sokolow et al. 2014
  
  par.all.ros['k'] = k.ros  # alternate value for M. rosenbergii, from Sampaio & Valenti 1996: 0.0104333333
  

#allow for one year run in to display epi model at eqbm ###########
t.yr1 = c(0:365) 
nstart.yr1 = c(S1 = allvh.eqbm.imm$S1, S2 = allvh.eqbm.imm$S2, S3 = allvh.eqbm.imm$S3, 
               E1 = allvh.eqbm.imm$E1, E2 = allvh.eqbm.imm$E2, E3 = allvh.eqbm.imm$E3, 
               I1 = allvh.eqbm.imm$I1, I2 = allvh.eqbm.imm$I2, I3 = allvh.eqbm.imm$I3, 
               Wt = allvh.eqbm.imm$Wt, Wu = allvh.eqbm.imm$Wu)

yr1 = as.data.frame(ode(nstart.yr1,t.yr1,snail_epi_allvh_imm,par.snails.imm))

  yr1$P = 0   #Add prawn variable to integrate with prawn stocking sims
  yr1$L = 0   #Add prawn variable to integrate with prawn stocking sims
  yr1$W = cov*yr1$Wt + (1-cov)*yr1$Wu
  yr1$prev = pnbinom(2, size = par.snails.imm['phi'], mu = yr1$W, lower.tail = FALSE)   
  yr1$S.t = (yr1$S1 + yr1$S2 + yr1$S3) / area        # density susceptible snails
  yr1$E.t = (yr1$E1 + yr1$E2 + yr1$E3) / area        # density exposed snails 
  yr1$I.t = (yr1$I1 + yr1$I2 + yr1$I3 ) / area                # density infected snails
  yr1$N.t = (yr1$S.t + yr1$E.t + yr1$I.t)            # density snails
  yr1$t.1 = (yr1$S1 + yr1$E1 + yr1$I1) / area                    # density snails of size class 1
  yr1$t.2 = (yr1$S2 + yr1$E2 + yr1$I2) / area      # density snails of size class 2
  yr1$t.3 = (yr1$S3 + yr1$E3 + yr1$I3) / area      # density snails of size class 3

#Simulate annual MDA for n years ########
#mda events
  mdas = data.frame(var = rep('Wt', years),
                    time = 365*c(1:years)+1,
                    value = rep((1-cov*eff), years),
                    method = rep('multiply', years))
  
  sim.mda = as.data.frame(ode(nstart.yr1,t.all,snail_epi_allvh_imm,par.snails.imm,
                          events = list(data = mdas)))
  
  sim.mda$P = 0   #Add prawn variable to integrate with prawn stocking sims
  sim.mda$L = 0   #Add prawn variable to integrate with prawn stocking sims
  sim.mda$W = cov*sim.mda$Wt + (1-cov)*sim.mda$Wu
  sim.mda$prev = pnbinom(2, size = par.snails.imm['phi'], mu = sim.mda$W, lower.tail = FALSE)   
  sim.mda$S.t = (sim.mda$S1 + sim.mda$S2 + sim.mda$S3) / area        # density susceptible snails
  sim.mda$E.t = (sim.mda$E1 + sim.mda$E2 + sim.mda$E3) / area        # density exposed snails 
  sim.mda$I.t = (sim.mda$I1 + sim.mda$I2 + sim.mda$I3 ) / area                    # density infected snails
  sim.mda$N.t = (sim.mda$S.t + sim.mda$E.t + sim.mda$I.t)            # density snails
  sim.mda$t.1 = (sim.mda$S1 + sim.mda$E1 + sim.mda$I1) / area                    # density snails of size class 1
  sim.mda$t.2 = (sim.mda$S2 + sim.mda$E2 + sim.mda$I2) / area      # density snails of size class 2
  sim.mda$t.3 = (sim.mda$S3 + sim.mda$E3 + sim.mda$I3) / area      # density snails of size class 3
  
  sim.mda = rbind(yr1, sim.mda)
  
#Simulate M. volenhovenii stocking for n years ########
sim.vol = as.data.frame(ode(nstart.vol,t.all,snail_prawn_model_imm,par.all.vol,
                              events = list(data = stocks.vol)))
  
  sim.vol$W = cov*sim.vol$Wt + (1-cov)*sim.vol$Wu
  sim.vol$prev = pnbinom(2, size = par.all.vol["phi"], mu = sim.vol$W, lower.tail = FALSE)   
  sim.vol$S.t = (sim.vol$S1 + sim.vol$S2 + sim.vol$S3) / area        # density susceptible snails
  sim.vol$E.t = (sim.vol$E1 + sim.vol$E2 + sim.vol$E3) / area        # density exposed snails 
  sim.vol$I.t = (sim.vol$I1 + sim.vol$I2 + sim.vol$I3 ) / area                    # density infected snails
  sim.vol$N.t = (sim.vol$S.t + sim.vol$E.t + sim.vol$I.t)            # density snails
  sim.vol$t.1 = (sim.vol$S1 + sim.vol$E1 + sim.vol$I1) / area                          # density snails of size class 1
  sim.vol$t.2 = (sim.vol$S2 + sim.vol$E2 + sim.vol$I2) / area      # density snails of size class 2
  sim.vol$t.3 = (sim.vol$S3 + sim.vol$E3 + sim.vol$I3) / area      # density snails of size class 3
  
  sim.vol = rbind(yr1, sim.vol)
  
#Simulate M. rosenbergii stocking for n years ########
  sim.ros = as.data.frame(ode(nstart.ros,t.all,snail_prawn_model_imm,par.all.ros,
                              events = list(data = stocks.ros)))
  
  sim.ros$W = cov*sim.ros$Wt + (1-cov)*sim.ros$Wu
  sim.ros$prev = pnbinom(2, size = par.all.ros["phi"], mu = sim.ros$W, lower.tail = FALSE)   
  sim.ros$S.t = (sim.ros$S1 + sim.ros$S2 + sim.ros$S3) / area        # density susceptible snails
  sim.ros$E.t = (sim.ros$E1 + sim.ros$E2 + sim.ros$E3) / area        # density exposed snails 
  sim.ros$I.t = (sim.ros$I1 + sim.ros$I2 + sim.ros$I3 ) / area                    # density infected snails
  sim.ros$N.t = (sim.ros$S.t + sim.ros$E.t + sim.ros$I.t)            # density snails
  sim.ros$t.1 = (sim.ros$S1 + sim.ros$E1 + sim.ros$I1) / area                          # density snails of size class 1
  sim.ros$t.2 = (sim.ros$S2 + sim.ros$E2 + sim.ros$I2) / area      # density snails of size class 2
  sim.ros$t.3 = (sim.ros$S3 + sim.ros$E3 + sim.ros$I3) / area      # density snails of size class 3
  
  sim.ros = rbind(yr1, sim.ros)

#Simulate annual mda along with volenhovenii stocking #############
mda.vol = rbind(mdas, stocks.vol)
  mda.vol = mda.vol[order(mda.vol$time),]
  
  sim.mda.vol = as.data.frame(ode(nstart.vol,t.all,snail_prawn_model_imm,par.all.vol,
                              events = list(data = mda.vol)))
  
  sim.mda.vol$W = cov*sim.mda.vol$Wt + (1-cov)*sim.mda.vol$Wu
  sim.mda.vol$prev = pnbinom(2, size = par.all.vol["phi"], mu = sim.mda.vol$W, lower.tail = FALSE)   
  sim.mda.vol$S.t = (sim.mda.vol$S1 + sim.mda.vol$S2 + sim.mda.vol$S3) / area        # density susceptible snails
  sim.mda.vol$E.t = (sim.mda.vol$E1 + sim.mda.vol$E2 + sim.mda.vol$E3) / area        # density exposed snails 
  sim.mda.vol$I.t = (sim.mda.vol$I1 + sim.mda.vol$I2 + sim.mda.vol$I3 ) / area                    # density infected snails
  sim.mda.vol$N.t = (sim.mda.vol$S.t + sim.mda.vol$E.t + sim.mda.vol$I.t)            # density snails
  sim.mda.vol$t.1 = (sim.mda.vol$S1 + sim.mda.vol$E1 + sim.mda.vol$I1) / area                          # density snails of size class 1
  sim.mda.vol$t.2 = (sim.mda.vol$S2 + sim.mda.vol$E2 + sim.mda.vol$I2) / area      # density snails of size class 2
  sim.mda.vol$t.3 = (sim.mda.vol$S3 + sim.mda.vol$E3 + sim.mda.vol$I3) / area      # density snails of size class 3
  
  sim.mda.vol = rbind(yr1, sim.mda.vol)

#Simulate annual mda along with rosenbergii stocking #############
mda.ros = rbind(mdas, stocks.ros)
  mda.ros = mda.ros[order(mda.ros$time),]
  
  sim.mda.ros = as.data.frame(ode(nstart.ros,t.all,snail_prawn_model_imm,par.all.ros,
                                  events = list(data = mda.ros)))
  
  sim.mda.ros$W = cov*sim.mda.ros$Wt + (1-cov)*sim.mda.ros$Wu
  sim.mda.ros$prev = pnbinom(2, size = par.all.ros["phi"], mu = sim.mda.ros$W, lower.tail = FALSE)   
  sim.mda.ros$S.t = (sim.mda.ros$S1 + sim.mda.ros$S2 + sim.mda.ros$S3) / area        # density susceptible snails
  sim.mda.ros$E.t = (sim.mda.ros$E1 + sim.mda.ros$E2 + sim.mda.ros$E3) / area        # density exposed snails 
  sim.mda.ros$I.t = (sim.mda.ros$I1 + sim.mda.ros$I2 + sim.mda.ros$I3 ) / area                    # density infected snails
  sim.mda.ros$N.t = (sim.mda.ros$S.t + sim.mda.ros$E.t + sim.mda.ros$I.t)            # density snails
  sim.mda.ros$t.1 = (sim.mda.ros$S1 + sim.mda.ros$E1 + sim.mda.ros$I1) / area                          # density snails of size class 1
  sim.mda.ros$t.2 = (sim.mda.ros$S2 + sim.mda.ros$E2 + sim.mda.ros$I2) / area      # density snails of size class 2
  sim.mda.ros$t.3 = (sim.mda.ros$S3 + sim.mda.ros$E3 + sim.mda.ros$I3) / area      # density snails of size class 3
  
  sim.mda.ros = rbind(yr1, sim.mda.ros)
    
```

```{r Fig_5, echo = FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
#plots over time with only MDA events #####
#Worm burden
  w.mda = sim.mda %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = c(0.825, 0.175),
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 14), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 14)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'A)', size = 8) +
            scale_y_continuous(breaks = seq(0,60,10),
                               labels = c('0', '10', '20', '30', '40', '   50', '   60'),
                               limits = c(0, 61)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
    
  w.mda
  
#plot snail infection dynamics over time with MDA events  
snail.mda = sim.mda %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = c(0.75,0.4),
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 14), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 14))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'B)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(0, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda

#plots over time with volenhovenii stocking events ######
#worm burden
  w.vol = sim.vol %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'C)', size = 8) +
            scale_y_continuous(breaks = seq(0,60,10),
                               labels = c('0', '10', '20', '30', '40', '   50', '   60'),
                               limits = c(0, 61)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.vol
  
#plot snail infection dynamics over time with volenhovenii stocking events  
snail.vol = sim.vol %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'D)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.vol
  
#plots over time with rosenbergii stocking events  ###########
  w.ros = sim.ros %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'D)', size = 8) +
            scale_y_continuous(breaks = seq(0,60,10),
                               labels = c('0', '10', '20', '30', '40', '   50', '   60'),
                               limits = c(0, 61)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.ros
  
#plot snail infection dynamics over time with rosenbergii stocking events  
snail.ros = sim.ros %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'D)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.ros
  
#plots over time with volenhovenii stocking events and mda events ##############
w.mda.vol = sim.mda.vol %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,60,10),
                               labels = c('0', '10', '20', '30', '40', '   50', '   60'),
                               limits = c(0, 61)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1) 
  
  w.mda.vol

#Plot snail infection dynamics under repeated MDA and volenhovenii stocking
snail.mda.vol = sim.mda.vol %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)
  
  snail.mda.vol

#plot worm burden over time with volenhovenii stocking events and mda events #######
w.mda.ros = sim.mda.ros %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,60,10),
                               labels = c('0', '10', '20', '30', '40', '   50', '   60'),
                               limits = c(0, 61)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.mda.ros
  
#Plot snail infection dynamics under repeated MDA and rosenbergii stocking
snail.mda.ros = sim.mda.ros %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda.ros
  
  
#plot combined figure with multiplot ###############   
  fig5.layout = matrix(c(1,2,
                         3,4,
                         5,6), ncol = 2, byrow = T)

  multiplot(w.mda, snail.mda, 
            w.vol, snail.vol, 
            w.mda.vol, snail.mda.vol,
            layout = fig5.layout)
  
```

