---
title: "Epi Simulations"
author: "Chris Hoover"
date: "October 4, 2018"
output: 
  pdf_document:
    toc: TRUE
    toc_depth: 3
geometry: margin = 0.5in    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(deSolve)
require(sensitivity)
require(parallel)
require(kableExtra)
require(broom)
require(directlabels)
require(tidyverse)

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
    library(grid)
    
    # Make a list from the ... arguments and plotlist
    plots <- c(list(...), plotlist)
    
    numPlots = length(plots)
    
    # If layout is NULL, then use 'cols' to determine layout
    if (is.null(layout)) {
      # Make the panel
      # ncol: Number of columns of plots
      # nrow: Number of rows needed, calculated from # of cols
      layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                       ncol = cols, nrow = ceiling(numPlots/cols))
    }
    
    if (numPlots==1) {
      print(plots[[1]])
      
    } else {
      # Set up the page
      grid.newpage()
      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
      
      # Make each plot, in the correct location
      for (i in 1:numPlots) {
        # Get the i,j matrix positions of the regions that contain this subplot
        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
        
        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                        layout.pos.col = matchidx$col))
      }
    }
  }

#Function from stack overflow (https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames)  
  expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...))

# Number of years to simulate
  years = 10

```

# Epi preparation  
Load all functions, models, parameter sets and so some initial runs to get equilibrium starting values, set snail immigration parameters, get prawn stocking data frames used in integrated model simulations, generated MDA events data frames, 1 year simulation run in for display in plots, etc.

```{r snail_prep, warnings=FALSE, cache = TRUE}
#Load all necessary functions, models, and parameter sets
source('../R/Prawn_aquaculture/prawn_aquaculture_mod.R')
source('../R/Prawn_aquaculture/prawn_aquaculture_sim.R')
source("../R/Epi_Model/snail_epi_mod_no_diag_immigration.R")
source("../R/Combined_Model/epi_no_diag_prawn_immigration_mod.R")
source("../R/Combined_Model/epi_no_diag_prawn_sim.R")
source("../Data/snail_epi_parameters.R")
source("../Data/combined_parameters.R")
source("../Data/aquaculture_parameters.R")
source("../Data/Ranjeet_Kurup_06_data.R")

  eta.lm = lm(marketable ~ dens, data = rk06)

source("../R/Sensitivity_Analysis/sensitivity_prep.R")

par.all = c(par.aqua, par.snails.imm, par.epi_prawn)

#Load some parameters from the prawn aquaculture simulations needed here
qwraps2::lazyload_cache_labels("Opt_stock", 
                               path = "Prawn_Aquaculture_Profit_Maximization_cache/latex/")

#Run to equilibrium to get eqbm values of state variables
allvh.eqbm.run.imm0 = as.data.frame(ode(nstart.sn,
                                        t.sn,
                                        snail_epi_allvh_imm,
                                        par.snails.imm))

  allvh.eqbm.imm0 = allvh.eqbm.run.imm0[dim(allvh.eqbm.run.imm0)[1],]

#Add immigration parameters based on immigration-free eqbm, add immigration parameter  
  par.snails.imm["xi"] <- par.all["xi"] <-  0.2/365  # 20% per year as in Head et al snail migration paper
  par.snails.imm["siteS1"] <- par.all["siteS1"] <- allvh.eqbm.imm0$S1 
  par.snails.imm["siteS2"] <- par.all["siteS2"] <- allvh.eqbm.imm0$S2 
  par.snails.imm["siteS3"] <- par.all["siteS3"] <- allvh.eqbm.imm0$S3 
  par.snails.imm["siteE1"] <- par.all["siteE1"] <- allvh.eqbm.imm0$E1 
  par.snails.imm["siteE2"] <- par.all["siteE2"] <- allvh.eqbm.imm0$E2 
  par.snails.imm["siteE3"] <- par.all["siteE3"] <- allvh.eqbm.imm0$E3 
  par.snails.imm["siteI1"] <- par.all["siteI1"] <- allvh.eqbm.imm0$I1 
  par.snails.imm["siteI2"] <- par.all["siteI2"] <- allvh.eqbm.imm0$I2 
  par.snails.imm["siteI3"] <- par.all["siteI3"] <- allvh.eqbm.imm0$I3 

#Rerun to eqbm with immigration
allvh.eqbm.run.imm = as.data.frame(ode(setNames(as.numeric(allvh.eqbm.imm0[-1]), names(allvh.eqbm.imm0)[-1]),
                                       t.sn,
                                       snail_epi_allvh_imm,
                                       par.snails.imm))

#Save for eqbm starting values in further simulations
  allvh.eqbm.imm = allvh.eqbm.run.imm %>% filter(time == max(time)) %>% select(S1:Wu) %>% unlist()


## Set initial values and parameters ###########
t.all = c(1:(365*years*2))+365

#Starting values from model equilibrium
nstart = allvh.eqbm.imm

#Volenhovenii stocking and harvesting events ###########
#Create data frame representing stocking and harvesting events for M. vollenhovenii at optimal management
  harvest.t.vol = opt.vol$time           #Optimal harvest time from volenhovenii optimization
  n.harvest.vol = floor((years*365)/harvest.t.vol)
  stocks.vol = data.frame(var = rep(c('P', 'L'), n.harvest.vol+1),
                          time = rep(366 + harvest.t.vol*c(0:n.harvest.vol), each = 2),
                          value = rep(c(opt.vol$P_nought, opt.vol$L_nought), n.harvest.vol+1),
                          method = rep('rep', (n.harvest.vol+1)*2))
  
    vol.harvests = stocks.vol[seq(1, nrow(stocks.vol), 2), 2]  

  par.all.vol = par.all  
    par.all.vol['k'] <- k.vol
  
#Rosenbergii stocking and harvesting events ###########
#Create dataframe represnting stocking and harvesting of M. rosenbergii prawns  
  harvest.t.ros = opt.ros$time
  n.harvest.ros = floor((years*365)/harvest.t.ros)
  stocks.ros = data.frame(var = rep(c('P', 'L'), n.harvest.ros+1),
                          time = rep(366 + harvest.t.ros*c(0:n.harvest.ros), each = 2),
                          value = rep(c(opt.ros$P_nought, opt.ros$L_nought), n.harvest.ros+1),
                          method = rep('rep', (n.harvest.ros+1)*2))
  
    ros.harvests = stocks.ros[seq(1, nrow(stocks.ros), 2), 2]
  
  par.all.ros = par.all  
    par.all.ros['k'] = k.ros  # alternate value for M. rosenbergii, from Sampaio & Valenti 1996: 0.0104333333
  
#mda events #######
  mdas = data.frame(var = rep('Wt', years+1),
                    time = 365*c(0:years+1)+1,
                    value = rep((1-eff), years+1),
                    method = rep('multiply', years+1))

#Combined MDA and vollenhovenii stocking events #######
  mda.vol = rbind(mdas, stocks.vol)
  mda.vol = mda.vol[order(mda.vol$time),]

#Combined MDA and rosenbergii stocking events #######
  mda.ros = rbind(mdas, stocks.ros)
  mda.ros = mda.ros[order(mda.ros$time),]
  
#allow for one year run in to display epi model at eqbm ###########
t.yr1 = c(0:365) 

yr1 = as.data.frame(ode(nstart,
                        t.yr1,
                        snail_epi_allvh_imm,
                        par.snails.imm)) %>% 
  mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
         L = 0, #Add prawn variable to integrate with prawn stocking sims
         W = cvrg*Wt + (1-cvrg)*Wu,
         prev = pnbinom(2, size = par.snails.imm['phi'], mu = W, lower.tail = FALSE),
         S.t = (S1 + S2 + S3) / area,  # density susceptible snails
         E.t = (E1 + E2 + E3) / area,  # density exposed snails 
         I.t = (I1 + I2 + I3 ) / area, # density infected snails
         N.t = (S.t + E.t + I.t), # total density snails
         t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
         t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
         t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  

# Prep parameter sets and first year for sims with no migration #########
#Simulations with migration to/from external sources absent
  par.all.vol.nomig  <- par.all.vol
  par.all.ros.nomig  <- par.all.ros
  par.snails.nomig <- par.snails.imm
  
  par.all.vol.nomig["xi"] <- 0
  par.all.ros.nomig["xi"] <- 0
  par.snails.nomig["xi"] <- 0
  
#allow for one year run in to display epi model at eqbm
yr1.nomig = as.data.frame(ode(nstart,
                              t.yr1,
                              snail_epi_allvh_imm,
                              par.snails.nomig))  %>% 
  mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
         L = 0, #Add prawn variable to integrate with prawn stocking sims
         W = cvrg*Wt + (1-cvrg)*Wu,
         prev = pnbinom(2, size = par.snails.nomig['phi'], mu = W, lower.tail = FALSE),
         S.t = (S1 + S2 + S3) / area,  # density susceptible snails
         E.t = (E1 + E2 + E3) / area,  # density exposed snails 
         I.t = (I1 + I2 + I3 ) / area, # density infected snails
         N.t = (S.t + E.t + I.t), # total density snails
         t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
         t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
         t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  

```

# Intervention simulations  
## Do nothing   
Simulations through `r print(years)` years for reference to compare effect of intervetions

```{r do_nothing, fig.height=3, fig.width=8, cache = TRUE}
  sim.nothing = as.data.frame(ode(nstart,
                                  t.all,
                                  snail_epi_allvh_imm,
                                  par.snails.imm)) %>% 
    mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
           L = 0, #Add prawn variable to integrate with prawn stocking sims
           W = cvrg*Wt + (1-cvrg)*Wu,
           prev = pnbinom(2, size = par.snails.imm['phi'], mu = W, lower.tail = FALSE),
           S.t = (S1 + S2 + S3) / area,  # density susceptible snails
           E.t = (E1 + E2 + E3) / area,  # density exposed snails 
           I.t = (I1 + I2 + I3 ) / area, # density infected snails
           N.t = (S.t + E.t + I.t), # total density snails
           t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
           t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
           t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  
  
  sim.nothing = rbind(yr1, sim.nothing)

# Plot Worm burden over time with only MDA intervention #####
  w.nothing = sim.nothing %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = c(0.825, 0.175),
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 14), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 14)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 80, label = 'A)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1) +
            ggtitle("Mean worm burden over time, no intervention")
    
  w.nothing
  
# Plot snail infection dynamics over time with MDA events  ########
snail.nothing = sim.nothing %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = c(0.35,0.4),
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 14), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 14))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'B)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(0, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
              ggtitle("Snail infection dynamics over time, no intervention")
  
  snail.nothing
```


## MDA intervention   
Simulate annual MDA for `r print(years)` years assuming `r paste0(eff, "%")` drug efficacy and `r paste0((1-cvrg), "%")` systematic non-compliance, then run for an additional `r print(years)` to show how rebound might occur 
```{r mda_sim, fig.height=3, fig.width=8, cache = TRUE}
#Simulate annual MDA for n years ########
  sim.mda = as.data.frame(ode(nstart,
                              t.all,
                              snail_epi_allvh_imm,
                              par.snails.imm,
                              events = list(data = mdas))) %>% 
    mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
           L = 0, #Add prawn variable to integrate with prawn stocking sims
           W = cvrg*Wt + (1-cvrg)*Wu,
           prev = pnbinom(2, size = par.snails.imm['phi'], mu = W, lower.tail = FALSE),
           S.t = (S1 + S2 + S3) / area,  # density susceptible snails
           E.t = (E1 + E2 + E3) / area,  # density exposed snails 
           I.t = (I1 + I2 + I3 ) / area, # density infected snails
           N.t = (S.t + E.t + I.t), # total density snails
           t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
           t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
           t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  
  
  sim.mda = rbind(yr1, sim.mda)

# Plot Worm burden over time with only MDA intervention #####
  w.mda = sim.mda %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = c(0.825, 0.175),
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 14), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 14)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 80, label = 'A)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
            ggtitle("Mean worm burden over time, annual MDA")
    
  w.mda
  
# Plot snail infection dynamics over time with MDA events  ########
snail.mda = sim.mda %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = c(0.35,0.4),
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 14), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 14))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'B)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(0, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
              ggtitle("Snail infection dynamics over time, annual MDA")
  
  snail.mda
  
```
## Prawn-only Intervention  
Simulate prawn intervention as `r print(years)` years of stocking and harvesting in a hypothetical transmission site under optimal management for each species  
### M. rosenbergii  
```{r ros_sim, fig.height=5, fig.width=8, cache = TRUE}
#Simulate M. rosenbergii stocking for n years ########
  sim.ros = prawn_sim(t.runup = c(1:366), 
                      t.intervene = c(366:((years+1)*365)), 
                      t.post = c(((years+1)*365):((years*2+1)*365)),
                      nstart = nstart,
                      parameters = par.all.ros, 
                      stock.events = stocks.ros)

# Plot worm burden over time with rosenbergii stocking events  ###########
  w.ros = sim.ros %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 80, label = 'D)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1) +
            ggtitle("Mean worm burden over time, prawn intervention",
                    subtitle = "M. rosenbergii")
  
  w.ros
  
  
#  Plot snail infection dynamics over time with rosenbergii stocking events  ########
snail.ros = sim.ros %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'C)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
              ggtitle("Snail infection dynamics over time, prawn intervention",
                      subtitle = "M. rosenbergii")
  
  snail.ros
```

### M. vollenhovenii  
```{r vol_sim, fig.height=5, fig.width=8, cache = TRUE}
# Simulate M. vollenhovenii stocking for n years ########
  sim.vol = prawn_sim(t.runup = c(1:366), 
                      t.intervene = c(366:((years+1)*365)), 
                      t.post = c(((years+1)*365):((years*2+1)*365)),
                      nstart = nstart,
                      parameters = par.all.vol.nomig, 
                      stock.events = stocks.vol)

# Plot worm burden over time with volenhovenii stocking events ######
  w.vol = sim.vol %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 80, label = 'C)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
            ggtitle("Mean worm burden over time, prawn intervention",
                    subtitle = "M. vollenhovenii")
  
  w.vol
  
# Plot snail infection dynamics over time with volenhovenii stocking events  #########
snail.vol = sim.vol %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'D)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
              ggtitle("Snail infection dynamics over time, prawn intervention",
                      subtitle = "M. vollenhovenii")
  
  snail.vol
  
```

## Combined Interventions  
Simulate prawn intervention as `r print(years)` years of stocking and harvesting in a hypothetical transmission site under optimal management for each species in addition to annual MDA with same assumptions as above    

### M. rosenbergii  
```{r ros_mda_sim, fig.height=5, fig.width=8, cache = TRUE}
#Simulate annual mda along with rosenbergii stocking #############
  sim.mda.ros = prawn_sim(t.runup = c(1:366), 
                          t.intervene = c(366:((years+1)*365)), 
                          t.post = c(((years+1)*365):((years*2+1)*365)),
                          nstart = nstart,
                          parameters = par.all.ros, 
                          stock.events = mda.ros)

# Plot worm burden over time with rosenbergii stocking events and mda events #######
w.mda.ros = sim.mda.ros %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 80, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            ggtitle("Mean worm burden over time, prawn + MDA intervention",
                    subtitle = "M. rosenbergii")
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.mda.ros
  
# snail infection dynamics over time with rosenbergii stocking events and mda events #####
snail.mda.ros = sim.mda.ros %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              ggtitle("Snail infection dynamics over time, prawn + MDA intervention",
                      subtitle = "M. rosenbergii")
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda.ros
  
```

### M. vollenhovenii  
```{r vol_mda_sim, fig.height=5, fig.width=8, cache = TRUE}
# Simulate annual mda along with volenhovenii stocking #############
  sim.mda.vol = prawn_sim(t.runup = c(1:366), 
                          t.intervene = c(366:((years+1)*365)), 
                          t.post = c(((years+1)*365):((years*2+1)*365)),
                          nstart = nstart,
                          parameters = par.all.vol, 
                          stock.events = mda.vol)
  
# plot worm burden over time with volenhovenii stocking events and mda events ##############
w.mda.vol = sim.mda.vol %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 80, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1)  +
            ggtitle("Mean worm burden over time, prawn + MDA intervention",
                    subtitle = "M. vollenhovenii")
  
  w.mda.vol

# PLot snail infection dynamics over time with volenhovenii stocking events and mda events ##########
snail.mda.vol = sim.mda.vol %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1) +
              ggtitle("Snail infcetion dynamics over time, prawn + MDA intervention",
                      subtitle = "M. vollenhovenii")
  
  snail.mda.vol

```

## Final epi fig   
```{r Epi_sim_final_fig, fig.height=10.5, fig.width=8, cache = TRUE}
# worm burden over time for MDA only, prawn only, and mda+prawn interventions #########
  w.nothing <- sim.nothing %>% mutate(Intervention = "None") %>% dplyr::select(time, W, Intervention)
  w.mda2 <- sim.mda %>% mutate(Intervention = "MDA Only") %>% dplyr::select(time, W, Intervention)
  w.ros2 <- sim.ros %>% mutate(Intervention = "Prawns Only") %>% dplyr::select(time, W, Intervention)
  w.mda.ros2 <- sim.mda.ros %>% mutate(Intervention = "MDA + Prawns") %>% dplyr::select(time, W, Intervention)

w.plot <- rbind(w.nothing, w.mda2, w.ros2, w.mda.ros2) %>% 
    ggplot(aes(x = time, y = W, col = Intervention)) + 
      geom_line(size = 1.25) + 
      theme_bw() +
      theme(legend.position = c(0.4, 0.55),
            legend.background = element_rect(fill = "transparent"),
            axis.text = element_text(size = 12),  #increase axis label size
            axis.title = element_text(size = 14), #increase axis title size
            axis.title.x=element_blank(),         #Suppress x axis
            axis.text.x=element_blank(),          #Suppress x axis
            title = element_text(size = 14)) +    #increase title size
      scale_color_manual(values = c("None"="darkred",
                                    "MDA Only"="purple", 
                                    "Prawns Only"="blue", 
                                    "MDA + Prawns"="gold")) +
      annotate('text', x = 365, y = 83, label = 'A)', size = 8) +
      labs(x = 'time (years)', y = expression(italic('W'))) +
              scale_y_continuous(breaks = seq(0,80,10),
                                 labels = paste("  ", seq(0,80,10)),
                                 limits = c(0, 85)) +
      geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1) 

# plot combined 3-panel figure with combined worm burden trajectories with multiplot ###############   
  epi_3p_layout = matrix(c(1,2,3), ncol = 1, byrow = T)

  multiplot(w.plot, 
            snail.mda + ggtitle(""), 
            snail.ros + ggtitle(""), 
            layout = epi_3p_layout)
```

```{r save_Epi_sim_final_fig, include = FALSE}
png("Figures/epi_sim_final_fig.png",
    width = 8, height = 10.5, units = "in",
    res = 300)

  multiplot(w.plot, 
            snail.mda + ggtitle(""), 
            snail.ros + ggtitle(""), 
            layout = epi_3p_layout)
  
dev.off()  
```

# Compare interventions with uncertainty   
To compare each intervention strategy across parametric uncertainty, the model is simulated across all LHC parameter sets under each intervention. The cumulative sum of mean worm burden over time for each intervention and each parameter set is recorded as measure of overall burden associated with each intervention and plotted here as a boxplot to compare the distribution of burdens associated with each intervention
```{r compare_interventions, cache = TRUE}
prawn_start = c("P" = opt.ros$P_nought,
                "L" = 40)

# Augment function to continue over errors
  possibly_comp_ints <- possibly(compare_interventions, 
                                      otherwise = data.frame("None" = NA, 
                                                             "MDA" = NA, 
                                                             "Prawns" = NA, 
                                                             "Prawns & MDA" = NA), 
                                      quiet = FALSE)

  comp_ints <- lhcpars %>%
    rowwise %>% do(pars = unlist(.)) %>% 
    bind_cols(pmap_df(., possibly_comp_ints, years = years)) %>% select(-pars) %>% 
    bind_cols(., lhcpars)

```

```{r comp_ints_boxplot, fig.height=5, fig.width=8}
comp_ints_bp <- comp_ints %>% 
  gather("Intervention", "Cum_W", None:Prawns...MDA) %>% 
  ggplot(aes(x = Intervention, y = log(Cum_W))) +
  geom_boxplot(width = 0.3) + theme_bw() +
  ggtitle("Comparison of intervention strategies",
          subtitle = "Based on cumulative mean worm burden") + 
      theme_bw() +
      theme(legend.position = c(0.35, 0.8),
            axis.text = element_text(size = 12),  #increase axis label size
            axis.title = element_text(size = 14), #increase axis title size
            title = element_text(size = 14))
```

```{r save_comp_ints_boxplot, include = FALSE}
comp_ints_bp

ggsave("Figures/compare_interventions_with_parameter_uncertainty.png",
       height = 5, width = 4, units = "in")
```