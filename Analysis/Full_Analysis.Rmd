---
title: "Full Analysis"
author: "Chris Hoover"
date: "August 22, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(deSolve)
require(sensitivity)
require(parallel)
require(kableExtra)
require(tidyverse)

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
    library(grid)
    
    # Make a list from the ... arguments and plotlist
    plots <- c(list(...), plotlist)
    
    numPlots = length(plots)
    
    # If layout is NULL, then use 'cols' to determine layout
    if (is.null(layout)) {
      # Make the panel
      # ncol: Number of columns of plots
      # nrow: Number of rows needed, calculated from # of cols
      layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                       ncol = cols, nrow = ceiling(numPlots/cols))
    }
    
    if (numPlots==1) {
      print(plots[[1]])
      
    } else {
      # Set up the page
      grid.newpage()
      pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
      
      # Make each plot, in the correct location
      for (i in 1:numPlots) {
        # Get the i,j matrix positions of the regions that contain this subplot
        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
        
        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                        layout.pos.col = matchidx$col))
      }
    }
  }

#Function from stack overflow (https://stackoverflow.com/questions/11693599/alternative-to-expand-grid-for-data-frames)  
  expand.grid.df <- function(...) Reduce(function(...) merge(..., by=NULL), list(...))

# Number of years to simulate
  years = 10
  
```

# Numeric estimation of max profit  
For each prawn species, shows trajectories of length, density, harvestable biomass, and profit over time over a range of stocking densities

```{r Opt_stock, include=FALSE, cache = TRUE}
source('../R/Prawn_aquaculture/prawn_aquaculture_mod.R')
source('../R/Prawn_aquaculture/prawn_aquaculture_sim.R')
source("../Data/aquaculture_parameters.R")
source("../Data/Ranjeet_Kurup_06_data.R")

  eta.lm = lm(marketable ~ dens, data = rk06)

#Simulation for eumetric curve for M. volenhovenii #####
#Starting length of 40 mm corresponds to juveniles of ~0.35 grams
opt.df = expand.grid.df(data.frame(t(par.aqua), c = cost, p = price, delta = delta), 
                        data.frame(L_nought = 40, P_nought = seq(500, 7500, 100))) 

#Get mgmt strategy that maximizes cumulative ten year profits
opt.vol.df <- opt.df %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii"))
  opt.vol <- opt.vol.df %>% filter(cum_profits == max(cum_profits))
opt.ros.df <- opt.df %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii"))
  opt.ros <- opt.ros.df %>% filter(cum_profits == max(cum_profits))

eum_dat <- rbind(opt.vol.df, opt.ros.df)  

```

```{r Fig2_Prep, warning=FALSE, include=FALSE, cache = TRUE}
test_p0s <- seq(500, 7500, 1000)  

aqua_sims_vol <- do.call(rbind, lapply(test_p0s, sim_aqua_time))
aqua_sims_ros <- do.call(rbind, lapply(test_p0s, sim_aqua_time, species = "M. rosenbergii"))

aqua_sims = as.data.frame(rbind(aqua_sims_vol, aqua_sims_ros)) %>% 
  mutate(n_harvest = ifelse(as.numeric(as.character(p_mass)) >= 30, as.numeric(as.character(n_harvest)), NA)) %>% 
  gather(key = "Variable", value = "Value", P_dens, L, harvest_mass, profit, n_harvest, cum_profits)

```

```{r Fig2, echo=FALSE, fig.height=10.5, fig.width=8}
  aqua_sims %>% mutate(time = as.numeric(time),
                       Value = as.numeric(Value)) %>% 
    filter(Variable %in% c("P_dens", "L", "n_harvest", "profit")) %>% 
    mutate(Variable = case_when(Variable == "P_dens" ~ "Density (P)",
                                Variable == "L" ~ "Average Length (mm)",
                                Variable == "n_harvest" ~ "Number of harvests",
                                Variable == "profit" ~ "Profit (USD)")) %>% 
    ggplot(aes(x = time, y = Value, col = P_start)) +
      geom_line(size = 1.25) +
      scale_color_manual(name = expression(P[0]),
                         values = c("gray90", "gray80", "red",
                                    "gray60", "gray50", "gray40",
                                    "gray30", "gray20")) +
      facet_grid(Variable ~ Species, scales = "free_y", switch = "y") +
      theme_bw() + 
      theme(axis.text = element_text(size = 12),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 15),#increase legend text size
            strip.text = element_text(size = 14))

```

# Example cycle  
Figure showing prawn aquaculture dynamics through time  

```{r sim_time_fig, echo=FALSE, warning = FALSE, fig.height=6, fig.width=8}
# First get simulation through time starting at optimal stocking density ######
opt.vol.time <- sim_aqua_time(opt.vol$P_nought)
opt.ros.time <- sim_aqua_time(opt.ros$P_nought, species = "M. rosenbergii")

  opt.time <- rbind(as.data.frame(opt.vol.time), as.data.frame(opt.ros.time)) %>% 
    mutate(n_harvest = ifelse(as.numeric(as.character(p_mass)) >= 30, as.numeric(as.character(n_harvest)), NA),
           cum_profits = as.numeric(as.character(n_harvest)) * as.numeric(as.character(profit))) %>% 
    gather(key = "Variable", value = "Value", P_dens, L, harvest_mass, profit, n_harvest, cum_profits)

    opt.time %>% mutate(time = as.numeric(time),
                        Value = as.numeric(Value),
                        Species = factor(Species, levels = c("M. rosenbergii", "M. vollenhovenii"))) %>% 
      filter(Variable %in% c("P_dens", "L", "harvest_mass", "cum_profits")) %>% 
      mutate(Variable = case_when(Variable == "P_dens" ~ "Density, P",
                                  Variable == "L" ~ "Mean Length, L (mm)",
                                  Variable == "harvest_mass" ~ "Harvest mass (kg)",
                                  Variable == "cum_profits" ~ "Ten-year Cumulative profit (USD)")) %>% 
      ggplot(aes(x = time, y = Value, col = Species)) +
        geom_line(size = 1.25) +
        geom_vline(xintercept = opt.vol$time, lty = 2, size = 1.1) +
        geom_vline(xintercept = opt.ros$time, lty = 3, size = 1.1) +
        scale_color_manual(values = c("red", "blue")) +
        facet_wrap( ~ Variable, scales = "free_y", nrow = 2) +
        labs(x = "Time (days)") +
        theme_bw() + 
        theme(legend.position = c(0.3, 0.2),
              axis.text = element_text(size = 12),  #increase axis label size
              axis.title = element_text(size = 18), #increase axis title size
              legend.title = element_blank(), #increase axis title size
              strip.text = element_text(size = 14))

```


# Eumetric curves   

```{r Fig3, include=FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
  eum_crv = ggplot(eum_dat, aes(x = P_nought/1000)) +
              theme_bw() +
              theme(legend.position = c(0.2, 0.1),        #place legend inside plot
                    axis.text = element_text(size = 15),  #increase axis label size
                    axis.title = element_text(size = 18), #increase axis title size
                    legend.text = element_text(size = 12),#increase legend text size
                    axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                    axis.text.x = element_blank(),
                    legend.title = element_blank())  +    #suppress legend title
              geom_line(aes(y = cum_profits/1000, col = Species), size = 1.25) +
              scale_color_manual(values = c("red", "blue")) +
              geom_hline(yintercept = 0, aes(col = grey20)) +
              annotate("text", x = 0, y = max(eum_dat$cum_profits), label = "A)", size = 8) +
              labs(y = expression(paste('10-Year Profits, ', CP^sp, ' (1000s USD)', sep = "")))  +
              scale_y_continuous(limits = c(min(eum_dat$cum_profits), 12500)/1000,
                                 breaks = seq(-2.500, 12.500, 2.500)) +
              scale_x_continuous(limits = c(0, 8),
                                 breaks = c(0, 2, 4, 6, 8))  
 
  prf_crv = ggplot(eum_dat, aes(x = P_nought/1000)) +
              theme_bw() +
              theme(legend.position = 'none',        #place legend inside plot
                    axis.text = element_text(size = 15),  #increase axis label size
                    axis.title = element_text(size = 18), #increase axis title size
                    legend.text = element_text(size = 12),#increase legend text size
                    axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                    axis.text.x = element_blank(),
                    legend.title = element_blank())  +    #suppress legend title
              geom_line(aes(y = profit, col = Species), size = 1.25) +
              scale_color_manual(values = c("red", "blue")) +
              geom_hline(yintercept = 0, aes(col = grey20)) +
              annotate("text", x = 0, y = max(eum_dat$profit), label = "B)", size = 8) +
              labs(y = expression(paste('Profit per cycle (USD)', sep = "")))  +
              scale_y_continuous(limits = c(-400, 410),
                                 breaks = seq(-400, 400, 200)) +
              scale_x_continuous(limits = c(0, 8),
                                 breaks = c(0, 2, 4, 6, 8))  

   
eum_time = ggplot(eum_dat, aes(x = P_nought/1000)) +
            theme_bw() +
            theme(legend.position = 'none',        #place legend inside plot
                  axis.text = element_text(size = 15),  #increase axis label size
                  axis.title = element_text(size = 18), #increase axis title size
                  axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
                  axis.text.x = element_blank(),
                  legend.text = element_text(size = 12),#increase legend text size
                  legend.title = element_blank())  +    #suppress legend title
            geom_line(aes(y = time, col = Species), size = 1.25) +
            annotate("text", x = 0, y = 365, label = "C)", size = 8) +
            scale_color_manual(values = c("red", "blue")) +
            labs(y = expression(paste('Harvest time, ', T[opt]^sp, ' (days)', sep = "")))  +
            scale_y_continuous(limits = c(0, 365),
                               breaks = c(0,60,120,180,240,300,365)) +
            scale_x_continuous(limits = c(0, 8),
                               breaks = c(0, 2, 4, 6, 8))  

eum_harvests = ggplot(eum_dat, aes(x = P_nought/1000)) +
            theme_bw() +
            theme(legend.position = 'none',        #place legend inside plot
                  axis.text = element_text(size = 15),  #increase axis label size
                  axis.title = element_text(size = 18), #increase axis title size
                  legend.text = element_text(size = 12),#increase legend text size
                  legend.title = element_blank())  +    #suppress legend title
            geom_line(aes(y = n_harvest, col = Species), size = 1.25) +
            annotate("text", x = 0, y = 25, label = "D)", size = 8) +
            scale_color_manual(values = c("red", "blue")) +
            labs(x = expression(paste('Stocking density, ', P[0],' (', Pm^-2, ")", sep = "")), 
                 y = "Harvests per 10 years")  +
            scale_y_continuous(limits = c(0, 30),
                               breaks = c(0,10,20,30),
                               labels = c("0", "10", "20", "  30")) +
            scale_x_continuous(limits = c(0, 8),
                               breaks = c(0, 2, 4, 6, 8))  


  
  eum.layout = matrix(c(1,2,3), ncol = 1, byrow = T)

  multiplot(eum_crv, prf_crv, eum_harvests, layout = eum.layout)

```

We want to add estimates of uncertainty to the eumetric curve in addition to the eumetric curve generated by point estimates of all parameters (above). We'll use the same parameter sets from the latin hypercube generated for the PRCC sensitivity analysis to run the model over all tested stocking densities 

```{r Fig3_sensitivity, include=FALSE, cache = TRUE}
source("../Data/snail_epi_parameters.R")
source("../Data/combined_parameters.R")

source("../R/Sensitivity_Analysis/sensitivity_prep.R")

# Get aquaculture parameters from LHC
  lhcpars.aqua = lhcpars[,which(colnames(lhcpars) %in% c(names(par.aqua), 'k.ros', 'c', 'p', 'delta'))]
  
# Get the stocking densities and starting length again
  test_starts <- expand.grid(L_nought = 40, P_nought = seq(500, 7500, 100))
  
  eum_sim <- expand.grid.df(lhcpars.aqua, test_starts)
  
  eum_sims_vol <- eum_sim %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii"))
  
    eum_sims_vol_sum <- eum_sims_vol %>%       #Summarise across parameter sets
      group_by(P_nought) %>%  
      summarise(Profit_Cycle_Med = median(profit),
                Profit_Cycle_upq = quantile(profit, 0.75),
                Profit_Cycle_loq = quantile(profit, 0.25),
                cum_Profit_Med = median(cum_profits),
                cum_Profit_min = min(cum_profits),
                cum_Profit_max = max(cum_profits),
                cum_Profit_upq = quantile(cum_profits, 0.75),
                cum_Profit_loq = quantile(cum_profits, 0.25),
                Harvest_time_med = median(time),
                Harvest_time_upq = quantile(time, 0.75),
                Harvest_time_loq = quantile(time, 0.25),
                n_harvest_med = median(n_harvest),
                n_harvest_upq = quantile(n_harvest, 0.75),
                n_harvest_loq = quantile(n_harvest, 0.25),
                Species = unique(Species),
                n_par_sets = n())
    
  eum_sims_ros <- eum_sim %>% bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii"))
  
    eum_sims_ros_sum <- eum_sims_ros %>%       #Summarise across parameter sets
      group_by(P_nought) %>%  
      summarise(Profit_Cycle_Med = median(profit),
                Profit_Cycle_upq = quantile(profit, 0.75),
                Profit_Cycle_loq = quantile(profit, 0.25),
                cum_Profit_Med = median(cum_profits),
                cum_Profit_min = min(cum_profits),
                cum_Profit_max = max(cum_profits),
                cum_Profit_upq = quantile(cum_profits, 0.75),
                cum_Profit_loq = quantile(cum_profits, 0.25),
                Harvest_time_med = median(time),
                Harvest_time_upq = quantile(time, 0.75),
                Harvest_time_loq = quantile(time, 0.25),
                n_harvest_med = median(n_harvest),
                n_harvest_upq = quantile(n_harvest, 0.75),
                n_harvest_loq = quantile(n_harvest, 0.25),
                Species = unique(Species),
                n_par_sets = n())
  
  eum_sims_all_sum = as.data.frame(rbind(eum_sims_vol_sum, eum_sims_ros_sum)) %>% 
    mutate(Species = factor(Species, levels = c("M. rosenbergii", "M. vollenhovenii")))
```

```{r Fig3_with_uncertainty, echo=FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
  eum_crv2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = cum_Profit_Med/1000, col = Species)) + 
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = cum_Profit_loq/1000, ymax = cum_Profit_upq/1000, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = c(0.2, 0.10),        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.title = element_blank())  +    #suppress legend title
      scale_color_manual(values = c("red", "blue")) +
      geom_hline(yintercept = 0, aes(col = grey20)) +
      annotate("text", x = 0, y = 12.5, label = "A)", size = 8) +
      labs(y = expression(paste('10-Year Profits', ' (1000s USD)', sep = "")))  +
      scale_y_continuous(limits = c(-3000, 12750)/1000,
                         breaks = seq(-2.500, 12.500, 2.500),
                         labels = paste("", seq(-2.500, 12.500, 2.500))) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  

  prf_crv2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = Profit_Cycle_Med, col = Species)) + 
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = Profit_Cycle_loq, ymax = Profit_Cycle_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = "none",        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.title = element_blank())  +    #suppress legend title
      scale_color_manual(values = c("red", "blue")) +
      geom_hline(yintercept = 0, aes(col = grey20)) +
      annotate("text", x = 0, y = 500, label = "B)", size = 8) +
      labs(y = expression(paste('Profit per cycle (USD)', sep = "")))  +
      scale_y_continuous(limits = c(-550, 550),
                         breaks = seq(-500, 500, 250)) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  


  eum_time2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = Harvest_time_med, col = Species)) +
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = Harvest_time_loq, ymax = Harvest_time_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = 'none',    
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            axis.title.x = element_blank(),       #Suppress x axis since it shares it with below plot
            axis.text.x = element_blank(),
            legend.text = element_text(size = 12),#increase legend text size
            legend.title = element_blank())  +    #suppress legend title
      annotate("text", x = 0, y = 365, label = "B)", size = 8) +
      scale_color_manual(values = c("red", "blue")) +
      labs(expression(paste('Harvest time, ', T[opt]^sp, ' (days)', sep = "")))  +
      scale_y_continuous(limits = c(0, 365),
                         breaks = c(0,60,120,180,240,300,365)) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  

  eum_harvests2 = eum_sims_all_sum %>% 
    ggplot(aes(x = P_nought/1000, y = n_harvest_med, col = Species)) +
      geom_line(size = 1.25) +
      geom_ribbon(aes(x = P_nought/1000, ymin = n_harvest_loq, ymax = n_harvest_upq, fill = Species), alpha = 0.3, size = 0) +
      theme_bw() +
      theme(legend.position = 'none',        #place legend inside plot
            axis.text = element_text(size = 15),  #increase axis label size
            axis.title = element_text(size = 18), #increase axis title size
            legend.text = element_text(size = 12),#increase legend text size
            legend.title = element_blank())  +    #suppress legend title
      annotate("text", x = 0, y = 30, label = "C)", size = 8) +
      scale_color_manual(values = c("red", "blue")) +
      labs(x = expression(paste('Stocking density, ', P[0],' (', Pm^-2, ")", sep = "")), 
           y = "Harvests per 10 years")  +
      scale_y_continuous(limits = c(0, 25),
                         breaks = seq(0,25,5),
                         labels = paste("    ", seq(0,25,5))) +
      scale_x_continuous(limits = c(0, 8),
                         breaks = c(0, 2, 4, 6, 8))  

  multiplot(eum_crv2, prf_crv2, eum_harvests2, layout = eum.layout)
```

# Optimal management table  

Also want a table showing set of parameters and outputs from "optimal management". Two approaches here: can either take uncertainty 

```{r op_mgmt_table, echo=FALSE, cache = TRUE}
#Function to return summary of a vector as median (IQR)
get_sum <- function(vec){
  paste0(round(median(vec), 2), 
         " (", round(quantile(vec, 0.25), 2), 
         " - ", round(quantile(vec, 0.75), 2), ")"  )
} 

  #Get optimal stocking parameters considering uncertainty for vollenhovenii
    opt.vol.unc <- eum_sims_vol %>% 
      group_by(P_nought) %>% 
      summarise(Cum_profit_med = median(cum_profits),
                harvest_time_sum = get_sum(time),
                harvest_mass_sum = get_sum(harvest_mass),
                harvest_length_sum = get_sum(L),
                harvest_number_sum = get_sum(P),
                profit_cycle_sum = get_sum(profit),
                roi_sum = get_sum(roi),
                n_harvest_sum = get_sum(n_harvest),
                cum_profit_sum = get_sum(cum_profits)) %>% 
      filter(Cum_profit_med == max(Cum_profit_med))
    
    knitr::kable(t(opt.vol.unc), caption = "Estimates of M. vollenhovenii optimal management (uncertainty during optimization)")

  #Get optimal stocking parameters considering uncertainty for rosenbergii
    opt.ros.unc <- eum_sims_ros %>% 
      group_by(P_nought) %>% 
      summarise(Cum_profit_med = median(cum_profits),
                harvest_time_sum = get_sum(time),
                harvest_mass_sum = get_sum(harvest_mass),
                harvest_length_sum = get_sum(L),
                harvest_number_sum = get_sum(P),
                profit_cycle_sum = get_sum(profit),
                roi_sum = get_sum(roi),
                n_harvest_sum = get_sum(n_harvest),
                cum_profit_sum = get_sum(cum_profits)) %>% 
      filter(Cum_profit_med == max(Cum_profit_med))
    
    knitr::kable(t(opt.ros.unc), caption = "Estimates of M. vollenhovenii optimal management (uncertainty during optimization)")

  vol_op_mgmt <- expand.grid.df(lhcpars.aqua, expand.grid(L_nought = opt.vol$L_nought, P_nought = opt.vol$P_nought)) %>% 
    bind_cols(pmap_df(., sim_aqua_eum, species = "M. vollenhovenii")) %>% group_by(P_nought, L_nought) %>% 
    summarise(harvest_time_med = get_sum(time),
              harvest_mass_med = get_sum(harvest_mass),
              harvest_length_med = get_sum(L),
              harvest_number_med = get_sum(P),
              profit_cycle_med = get_sum(profit),
              roi_med = get_sum(roi),
              n_harvest_med = get_sum(n_harvest),
              cum_profit_med = get_sum(cum_profits))

  knitr::kable(t(vol_op_mgmt), caption = "Estimates of M. vollenhovenii optimal management (parametric uncertainty)")

  ros_op_mgmt <- expand.grid.df(lhcpars.aqua, expand.grid(L_nought = opt.ros$L_nought, P_nought = opt.ros$P_nought)) %>% 
    bind_cols(pmap_df(., sim_aqua_eum, species = "M. rosenbergii")) %>% group_by(P_nought, L_nought) %>% 
    summarise(harvest_time_med = get_sum(time),
              harvest_mass_med = get_sum(harvest_mass),
              harvest_length_med = get_sum(L),
              harvest_number_med = get_sum(P),
              profit_cycle_med = get_sum(profit),
              roi_med = get_sum(roi),
              n_harvest_med = get_sum(n_harvest),
              cum_profit_med = get_sum(cum_profits))

  knitr::kable(t(ros_op_mgmt), caption = "Estimates of M. rosenbergii optimal management (parametric uncertainty)")
```

# Epi simulations  

```{r snail_prep, include=FALSE, cache = TRUE}
source("../R/Epi_Model/snail_epi_mod_no_diag_immigration.R")

#Run to equilibrium to get eqbm values of state variables
allvh.eqbm.run.imm0 = as.data.frame(ode(nstart.sn,
                                        t.sn,
                                        snail_epi_allvh_imm,
                                        par.snails.imm))

  allvh.eqbm.imm0 = allvh.eqbm.run.imm0[dim(allvh.eqbm.run.imm0)[1],]

#Add immigration parameters based on immigration-free eqbm, add immigration parameter  
  par.snails.imm["iota"] <- 0.2/365  # 20% per year as in Head et al snail migration paper
  par.snails.imm["siteS1"] <- allvh.eqbm.imm0$S1 
  par.snails.imm["siteS2"] <- allvh.eqbm.imm0$S2 
  par.snails.imm["siteS3"] <- allvh.eqbm.imm0$S3 
  par.snails.imm["siteE1"] <- allvh.eqbm.imm0$E1 
  par.snails.imm["siteE2"] <- allvh.eqbm.imm0$E2 
  par.snails.imm["siteE3"] <- allvh.eqbm.imm0$E3 
  par.snails.imm["siteI1"] <- allvh.eqbm.imm0$I1 
  par.snails.imm["siteI2"] <- allvh.eqbm.imm0$I2 
  par.snails.imm["siteI3"] <- allvh.eqbm.imm0$I3 

#Rerun to eqbm with immigration
allvh.eqbm.run.imm = as.data.frame(ode(setNames(as.numeric(allvh.eqbm.imm0[-1]), names(allvh.eqbm.imm0)[-1]),
                                       t.sn,
                                       snail_epi_allvh_imm,
                                       par.snails.imm))

#Save for eqbm starting values in further simulations
  allvh.eqbm.imm = allvh.eqbm.run.imm %>% filter(time == max(time)) %>% select(S1:Wu) %>% unlist()


## Set initial values and parameters ###########
t.all = c(1:(365*years*2))+365

#Starting values from model equilibrium
nstart = allvh.eqbm.imm

#Volenhovenii stocking and harvesting events ###########
#Create data frame representing stocking and harvesting events for M. vollenhovenii
  harvest.t.vol = opt.vol$time           #Optimal harvest time from volenhovenii optimization
  n.harvest.vol = floor((years*365)/harvest.t.vol)
  stocks.vol = data.frame(var = rep(c('P', 'L'), n.harvest.vol+1),
                          time = rep(366 + harvest.t.vol*c(0:n.harvest.vol), each = 2),
                          value = rep(c(opt.vol$P_nought, opt.vol$L_nought), n.harvest.vol+1),
                          method = rep('rep', (n.harvest.vol+1)*2))
  
    vol.harvests = stocks.vol[seq(1, nrow(stocks.vol), 2), 2]  

  par.all.vol = par.all  
    par.all.vol['k'] <- k.vol
  
#Rosenbergii stocking and harvesting events ###########
#Create dataframe represnting stocking and harvesting of M. rosenbergii prawns  
  harvest.t.ros = opt.ros$time
  n.harvest.ros = floor((years*365)/harvest.t.ros)
  stocks.ros = data.frame(var = rep(c('P', 'L'), n.harvest.ros+1),
                          time = rep(366 + harvest.t.ros*c(0:n.harvest.ros), each = 2),
                          value = rep(c(opt.ros$P_nought, opt.ros$L_nought), n.harvest.ros+1),
                          method = rep('rep', (n.harvest.ros+1)*2))
  
    ros.harvests = stocks.ros[seq(1, nrow(stocks.ros), 2), 2]
  
  par.all.ros = par.all  
    par.all.ros['k'] = k.ros  # alternate value for M. rosenbergii, from Sampaio & Valenti 1996: 0.0104333333
  
#mda events #######
  mdas = data.frame(var = rep('Wt', years+1),
                    time = 365*c(0:years+1)+1,
                    value = rep((1-eff), years+1),
                    method = rep('multiply', years+1))

#Combined MDA and vollenhovenii stocking events #######
  mda.vol = rbind(mdas, stocks.vol)
  mda.vol = mda.vol[order(mda.vol$time),]

#Combined MDA and rosenbergii stocking events #######
  mda.ros = rbind(mdas, stocks.ros)
  mda.ros = mda.ros[order(mda.ros$time),]
  
#allow for one year run in to display epi model at eqbm ###########
t.yr1 = c(0:365) 

yr1 = as.data.frame(ode(nstart,t.yr1,snail_epi_allvh_imm,par.snails.imm)) %>% 
  mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
         L = 0, #Add prawn variable to integrate with prawn stocking sims
         W = cov*Wt + (1-cov)*Wu,
         prev = pnbinom(2, size = par.snails.imm['phi'], mu = W, lower.tail = FALSE),
         S.t = (S1 + S2 + S3) / area,  # density susceptible snails
         E.t = (E1 + E2 + E3) / area,  # density exposed snails 
         I.t = (I1 + I2 + I3 ) / area, # density infected snails
         N.t = (S.t + E.t + I.t), # total density snails
         t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
         t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
         t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  

# Prep parameter sets and first year for sims with no migration #########
#Simulations with migration to/from external sources absent
  par.all.vol.nomig  <- par.all.vol
  par.all.ros.nomig  <- par.all.ros
  par.snails.nomig <- par.snails.imm
  
  par.all.vol.nomig["iota"] <- 0
  par.all.ros.nomig["iota"] <- 0
  par.snails.nomig["iota"] <- 0
  
#allow for one year run in to display epi model at eqbm
yr1.nomig = as.data.frame(ode(nstart,t.yr1,snail_epi_allvh_imm,par.snails.nomig))  %>% 
  mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
         L = 0, #Add prawn variable to integrate with prawn stocking sims
         W = cov*Wt + (1-cov)*Wu,
         prev = pnbinom(2, size = par.snails.nomig['phi'], mu = W, lower.tail = FALSE),
         S.t = (S1 + S2 + S3) / area,  # density susceptible snails
         E.t = (E1 + E2 + E3) / area,  # density exposed snails 
         I.t = (I1 + I2 + I3 ) / area, # density infected snails
         N.t = (S.t + E.t + I.t), # total density snails
         t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
         t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
         t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  

```

## MDA Intervention  
### With migration  
```{r mda_sim, echo=FALSE, fig.height=5, fig.width=8}
#Simulate annual MDA for n years ########
  
  sim.mda = as.data.frame(ode(nstart,
                              t.all,
                              snail_epi_allvh_imm,
                              par.snails.imm,
                              events = list(data = mdas))) %>% 
    mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
           L = 0, #Add prawn variable to integrate with prawn stocking sims
           W = cov*Wt + (1-cov)*Wu,
           prev = pnbinom(2, size = par.snails.imm['phi'], mu = W, lower.tail = FALSE),
           S.t = (S1 + S2 + S3) / area,  # density susceptible snails
           E.t = (E1 + E2 + E3) / area,  # density exposed snails 
           I.t = (I1 + I2 + I3 ) / area, # density infected snails
           N.t = (S.t + E.t + I.t), # total density snails
           t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
           t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
           t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  
  
  sim.mda = rbind(yr1, sim.mda)

# Plot Worm burden over time with only MDA intervention #####
  w.mda = sim.mda %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = c(0.825, 0.175),
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 14), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 14)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'A)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
    
  w.mda
  
# Plot snail infection dynamics over time with MDA events  ########
snail.mda = sim.mda %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = c(0.75,0.4),
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 14), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 14))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'B)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(0, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda
  
```

### No migration  
```{r mda_sim_nomig, echo=FALSE, fig.height=5, fig.width=8}
#Simulate annual MDA for n years with no migration ########
sim.mda.nomig = as.data.frame(ode(nstart,
                                  t.all,
                                  snail_epi_allvh_imm,
                                  par.snails.nomig,
                                  events = list(data = mdas))) %>% 
    mutate(P = 0, #Add prawn variable to integrate with prawn stocking sims
           L = 0, #Add prawn variable to integrate with prawn stocking sims
           W = cov*Wt + (1-cov)*Wu,
           prev = pnbinom(2, size = par.snails.imm['phi'], mu = W, lower.tail = FALSE),
           S.t = (S1 + S2 + S3) / area,  # density susceptible snails
           E.t = (E1 + E2 + E3) / area,  # density exposed snails 
           I.t = (I1 + I2 + I3 ) / area, # density infected snails
           N.t = (S.t + E.t + I.t), # total density snails
           t.1 = (S1 + E1 + I1) / area, # density snails of size class 1
           t.2 = (S2 + E2 + I2) / area, # density snails of size class 2
           t.3 = (S3 + E3 + I3) / area) # density snails of size class 3  
  
  sim.mda.nomig = rbind(yr1.nomig, sim.mda.nomig)

# PLot Worm burden over time with only MDA intervention and no migration #####
  w.mda.nomig = sim.mda.nomig %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = c(0.825, 0.175),
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 14), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 14)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'A)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
    
  w.mda.nomig
  

# Plot snail infection dynamics over time with MDA events and no migration ########
snail.mda.nomig = sim.mda.nomig %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = c(0.75,0.4),
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 14), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 14))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'B)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(0, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda.nomig
```

## Prawn-only Intervention  
### M. rosenbergii  
#### With migration  
```{r ros_sim, echo=FALSE, fig.height=5, fig.width=8}
source("../R/Combined_Model/epi_no_diag_prawn_immigration_mod.R")
source("../R/Combined_Model/epi_no_diag_prawn_sim.R")

#Simulate M. rosenbergii stocking for n years ########
  sim.ros = prawn_sim(t.runup = c(1:366), 
                      t.intervene = c(366:((years+1)*365)), 
                      t.post = c(((years+1)*365):((years*2+1)*365)),
                      nstart = nstart,
                      parameters = par.all.ros, 
                      stock.events = stocks.ros)

# Plot worm burden over time with rosenbergii stocking events  ###########
  w.ros = sim.ros %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'D)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.ros
  
  
#  Plot snail infection dynamics over time with rosenbergii stocking events  ########
snail.ros = sim.ros %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'C)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1) 
  
  snail.ros
```

#### No migration  
```{r ros_sim_nomig, echo=FALSE, fig.height=5, fig.width=8}
# Simulate M. rosenbergii stocking for n years ########
sim.ros.nomig = prawn_sim(t.runup = c(1:366), 
                          t.intervene = c(366:((years+1)*365)), 
                          t.post = c(((years+1)*365):((years*2+1)*365)),
                          nstart = nstart,
                          parameters = par.all.ros.nomig, 
                          stock.events = stocks.ros)

# Plot worm burden over time with rosenbergii stocking events  ###########
  w.ros.nomig = sim.ros.nomig %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'D)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.ros.nomig
  
# Plot snail infection dynamics over time with rosenbergii stocking events and no migration ########
snail.ros.nomig = sim.ros.nomig %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'C)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1) 

snail.ros.nomig    
```

### M. vollenhovenii  
#### With migration  
```{r vol_sim, echo=FALSE, fig.height=5, fig.width=8}
# Simulate M. vollenhovenii stocking for n years ########
  sim.vol = prawn_sim(t.runup = c(1:366), 
                      t.intervene = c(366:((years+1)*365)), 
                      t.post = c(((years+1)*365):((years*2+1)*365)),
                      nstart = nstart,
                      parameters = par.all.vol.nomig, 
                      stock.events = stocks.vol)

# Plot worm burden over time with volenhovenii stocking events ######
  w.vol = sim.vol %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'C)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.vol
  
# Plot snail infection dynamics over time with volenhovenii stocking events  #########
snail.vol = sim.vol %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'D)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.vol
  
```

#### No migration  
```{r vol_sim_nomig, echo=FALSE, fig.height=5, fig.width=8}
#Simulate M. volenhovenii stocking for n years ########
sim.vol.nomig = prawn_sim(t.runup = c(1:366), 
                          t.intervene = c(366:((years+1)*365)), 
                          t.post = c(((years+1)*365):((years*2+1)*365)),
                          nstart = nstart,
                          parameters = par.all.vol.nomig, 
                          stock.events = stocks.vol)
  
# Plot worm burden over time with volenhovenii stocking events ######
  w.vol.nomig = sim.vol.nomig %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'C)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.vol.nomig
  
# Plot snail infection dynamics over time with vollenhovenii stocking events and no migration ########
snail.vol.nomig = sim.vol.nomig %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'C)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1) 

snail.vol.nomig    
  
```

## Combined Intervention  
### M. rosenbergii  
#### With migration  
```{r ros_mda_sim, echo=FALSE, fig.height=5, fig.width=8}
#Simulate annual mda along with rosenbergii stocking #############
  sim.mda.ros = prawn_sim(t.runup = c(1:366), 
                          t.intervene = c(366:((years+1)*365)), 
                          t.post = c(((years+1)*365):((years*2+1)*365)),
                          nstart = nstart,
                          parameters = par.all.ros, 
                          stock.events = mda.ros)

# Plot worm burden over time with rosenbergii stocking events and mda events #######
w.mda.ros = sim.mda.ros %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.mda.ros
  
# snail infection dynamics over time with rosenbergii stocking events and mda events #####
snail.mda.ros = sim.mda.ros %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda.ros
  
```

#### No migration  
```{r ros_mda_sim_nomig, echo=FALSE, fig.height=5, fig.width=8}
#Simulate annual mda along with rosenbergii stocking #############
  sim.mda.ros.nomig = prawn_sim(t.runup = c(1:366), 
                                t.intervene = c(366:((years+1)*365)), 
                                t.post = c(((years+1)*365):((years*2+1)*365)),
                                nstart = nstart,
                                parameters = par.all.ros.nomig, 
                                stock.events = mda.ros)

# Plot worm burden over time with rosenbergii stocking events and mda events #######
w.mda.ros.nomig = sim.mda.ros.nomig %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  axis.title.x=element_blank(),         #Suppress x axis
                  axis.text.x=element_blank(),          #Suppress x axis
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2)
            #scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
            #                   labels = c(-1:years),
            #                   limits = c(0, (365*(years+1)+10)))
  
  w.mda.ros.nomig
  
# snail infection dynamics over time with rosenbergii stocking events and mda events #####
snail.mda.ros.nomig = sim.mda.ros.nomig %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    axis.title.x=element_blank(),         #Suppress x axis
                    axis.text.x=element_blank(),          #Suppress x axis
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2)
             # scale_x_continuous(breaks = seq(0, 365*(years+1), 365),
             #                   labels = c(-1:years),
             #                   limits = c(0, (365*(years+1)+10))) 
  
  snail.mda.ros.nomig
  
```


### M. vollenhovenii  
#### With migration  
```{r vol_mda_sim, echo=FALSE, fig.height=5, fig.width=8}
# Simulate annual mda along with volenhovenii stocking #############
  sim.mda.vol = prawn_sim(t.runup = c(1:366), 
                          t.intervene = c(366:((years+1)*365)), 
                          t.post = c(((years+1)*365):((years*2+1)*365)),
                          nstart = nstart,
                          parameters = par.all.vol, 
                          stock.events = mda.vol)
  
# plot worm burden over time with volenhovenii stocking events and mda events ##############
w.mda.vol = sim.mda.vol %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1) 
  
  w.mda.vol

# PLot snail infection dynamics over time with volenhovenii stocking events and mda events ##########
snail.mda.vol = sim.mda.vol %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)
  
  snail.mda.vol


```

#### No migration  
```{r vol_mda_sim_nomig, echo=FALSE, fig.height=5, fig.width=8}
#Simulate annual mda along with volenhovenii stocking #############
  sim.mda.vol.nomig = prawn_sim(t.runup = c(1:366), 
                                t.intervene = c(366:((years+1)*365)), 
                                t.post = c(((years+1)*365):((years*2+1)*365)),
                                nstart = nstart,
                                parameters = par.all.vol.nomig, 
                                stock.events = mda.vol)

# plot worm burden over time with volenhovenii stocking events and mda events ##############
w.mda.vol.nomig = sim.mda.vol.nomig %>% dplyr::select(time, W, Wt, Wu) %>% 
    gather("pop", "burden", W:Wu) %>% 
    mutate(Population = case_when(pop == "W" ~ "Mean", 
                                  pop == "Wt" ~ "Treated", 
                                  pop == "Wu" ~ "Untreated")) %>% 
    ggplot(aes(x = time, y = burden, lty = Population)) +
            theme_bw() +
            theme(legend.position = "none",
                  axis.text = element_text(size = 12),  #increase axis label size
                  axis.title = element_text(size = 15), #increase axis title size
                  title = element_text(size = 15)) +    #increase title size
            geom_line(col = 'purple') +
            labs(x = 'time (years)', y = expression(italic('W'))) +
            annotate('text', x = 365, y = 60, label = 'E)', size = 8) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
            geom_vline(xintercept = 365*(years+1), lty = 2) +
            scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                               labels = seq(365, 365*(years*2+1), 365*5)/365-1) 
  
  w.mda.vol.nomig

# PLot snail infection dynamics over time with volenhovenii stocking events and mda events ##########
snail.mda.vol.nomig = sim.mda.vol.nomig %>% dplyr::select(time, S.t, E.t, I.t, N.t) %>% 
  gather("class", "density", S.t:N.t) %>% 
  mutate(Infection = case_when(class == "N.t" ~ "Total",
                               class == "S.t" ~ "Susceptible",
                               class == "E.t" ~ "Exposed",
                               class == "I.t" ~ "Infected")) %>% 
  mutate(Infection = factor(Infection, levels = c("Total", "Susceptible", "Exposed", "Infected"))) %>% 
  ggplot(aes(x = time, y = density, col = Infection)) +
              theme_bw() +
              theme(legend.position = "none",
                    axis.text = element_text(size = 12),  #increase axis label size
                    axis.title = element_text(size = 15), #increase axis title size
                    title = element_text(size = 15))  +   #increase title size
              geom_line(size = 1.25) +
              scale_color_manual(values = c("Total"="black", 
                                            "Susceptible"="green", 
                                            "Exposed"="orange", 
                                            "Infected"="red")) +
              annotate('text', x = 365, y = 50, label = 'F)', size = 8) +
              labs(x = 'time (years)', y = expression(paste("Snail density (", 'N'[i], 'm'^'-2', ")"))) +
              scale_y_continuous(breaks = seq(0,50,10),
                                 labels = seq(0,50,10),
                                 limits = c(-0.1, 51)) +
              geom_vline(xintercept = 365*(years+1), lty = 2) +
              scale_x_continuous(breaks = seq(365, 365*(years*2+1), 365*5),
                                 labels = seq(365, 365*(years*2+1), 365*5)/365-1)
  
  snail.mda.vol.nomig
  
```

## Combined epi plots  
### Six panel variety  
```{r 6_pan_variety, echo=FALSE, fig.height=10.5, fig.width=8}
# plot combined 6-panel figure with multiplot ###############   
  fig5.layout = matrix(c(1,2,
                         3,4,
                         5,6), ncol = 2, byrow = T)

  multiplot(w.mda, snail.mda, 
            w.vol, snail.vol, 
            w.mda.vol, snail.mda.vol,
            layout = fig5.layout)

```

### Combined worm burden plots  
```{r epi_plot1, echo = FALSE, warning = FALSE, fig.height=4.5, fig.width=6}
  
# worm burden over time for MDA only, prawn only, and mda+prawn interventions #########
  w.mda2 <- sim.mda %>% mutate(Intervention = "MDA Only") %>% dplyr::select(time, W, Intervention)
  w.ros2 <- sim.ros %>% mutate(Intervention = "Prawns Only") %>% dplyr::select(time, W, Intervention)
  w.mda.ros2 <- sim.mda.ros %>% mutate(Intervention = "MDA + Prawns") %>% dplyr::select(time, W, Intervention)
  
  w.plot <- rbind(w.mda2, w.ros2, w.mda.ros2) %>% 
    ggplot(aes(x = time, y = W, col = Intervention)) + 
      geom_line(size = 1.25) + 
      theme_bw() +
    theme(legend.position = c(0.8, 0.8),
          axis.text = element_text(size = 12),  #increase axis label size
          axis.title = element_text(size = 14), #increase axis title size
          axis.title.x=element_blank(),         #Suppress x axis
          axis.text.x=element_blank(),          #Suppress x axis
          title = element_text(size = 14)) +    #increase title size
    scale_color_manual(values = c("MDA Only"="purple", 
                                  "Prawns Only"="blue", 
                                  "MDA + Prawns"="gold")) +
    annotate('text', x = 365, y = 60, label = 'A)', size = 8) +
    labs(x = 'time (years)', y = expression(italic('W'))) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
    geom_vline(xintercept = 365*(years+1), lty = 2)

# worm burden over time for MDA only, prawn only, and mda+prawn interventions no migration#########
  w.mda2.nomig <- sim.mda.nomig %>% mutate(Intervention = "MDA Only") %>% dplyr::select(time, W, Intervention)
  w.ros2.nomig <- sim.ros.nomig %>% mutate(Intervention = "Prawns Only") %>% dplyr::select(time, W, Intervention)
  w.mda.ros2.nomig <- sim.mda.ros.nomig %>% mutate(Intervention = "MDA + Prawns") %>% dplyr::select(time, W, Intervention)
  
  w.plot.nomig <- rbind(w.mda2.nomig, w.ros2.nomig, w.mda.ros2.nomig) %>% 
    ggplot(aes(x = time, y = W, col = Intervention)) + 
      geom_line(size = 1.25) + 
      theme_bw() +
    theme(legend.position = c(0.8, 0.8),
          axis.text = element_text(size = 12),  #increase axis label size
          axis.title = element_text(size = 14), #increase axis title size
          axis.title.x=element_blank(),         #Suppress x axis
          axis.text.x=element_blank(),          #Suppress x axis
          title = element_text(size = 14)) +    #increase title size
    scale_color_manual(values = c("MDA Only"="purple", 
                                  "Prawns Only"="blue", 
                                  "MDA + Prawns"="gold")) +
    annotate('text', x = 365, y = 60, label = 'A)', size = 8) +
    labs(x = 'time (years)', y = expression(italic('W'))) +
            scale_y_continuous(breaks = seq(0,80,10),
                               labels = paste("  ", seq(0,80,10)),
                               limits = c(0, 85)) +
    geom_vline(xintercept = 365*(years+1), lty = 2)
  
```

### Three panel essentials  
```{r 3_pan_variety, echo=FALSE, fig.height=10.5, fig.width=8}
# plot combined 3-panel figure with combined worm burden trajectories with multiplot ###############   
  epi_3p_layout = matrix(c(1,2,3), ncol = 1, byrow = T)

  multiplot(w.plot, snail.mda, snail.ros, layout = epi_3p_layout)

```

### 6-panel migration vs no migration comparison   
```{r 6_pan_mig_comp, echo = FALSE, warning = FALSE, fig.height=10.5, fig.width=8}
# plot combined 6-panel figure with combined worm burden trajectories with multiplot (shows migration and no migration results) ###############   
  epi_6p_layout = matrix(c(1,2,
                           3,4,
                           5,6), ncol = 2, byrow = T)

  multiplot(w.plot, w.plot.nomig, 
            snail.mda, snail.mda.nomig,
            snail.ros, snail.ros.nomig,
            layout = epi_6p_layout)

```

# Sensitivity analysis  
